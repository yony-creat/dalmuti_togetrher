<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° - ì„œë²„ ê¸´ê¸‰ ì—°ê²°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gun/0.2020.1239/gun.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; border: 1px solid #34495e; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        #status-bar { padding: 12px; margin-bottom: 15px; border-radius: 10px; font-size: 14px; background: #c0392b; font-weight: bold; transition: 0.3s; }
        .online { background: #27ae60 !important; }
        .hidden { display: none; }
        #debug-info { font-size: 10px; color: #666; margin-top: 20px; text-align: left; background: #000; padding: 5px; }
    </style>
</head>
<body>
    <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
    <div id="status-bar">ğŸ“¡ ì„œë²„ ì‹ í˜¸ íƒìƒ‰ ì¤‘...</div>

    <div id="setup-screen" class="screen">
        <div id="init-view">
            <button onclick="initCreateRoom()">â• ìƒˆ ë°© ë§Œë“¤ê¸°</button>
            <p style="font-size: 12px; color: #888; margin-top: 10px;">ìƒíƒœ ë°”ê°€ ì´ˆë¡ìƒ‰ì´ ë˜ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
        </div>
        <div id="join-view" class="hidden">
            <input type="text" id="my-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" autocomplete="off">
            <button onclick="processJoin()">ê²Œì„ ì…ì¥</button>
        </div>
    </div>

    <div id="debug-info" style="display:none;"></div>

<script>
    const sb = document.getElementById('status-bar');
    const dbg = document.getElementById('debug-info');

    // [ì¤‘ìš”] 403/503 ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠëŠ” ìµœì‹  ì•ˆì • ì„œë²„ ë¦¬ìŠ¤íŠ¸ë¡œ êµì²´
    const peers = [
        'https://gun-us.herokuapp.com/gun',
        'https://gun-eu.herokuapp.com/gun',
        'https://gun-manhattan.herokuapp.com/gun',
        'https://relay.peer.ooo/gun'
    ];

    let gun;
    try {
        gun = Gun({ peers: peers, localStorage: false });
        
        // ì—°ê²° ì„±ê³µ ê°ì§€ (í•˜ë‚˜ì˜ ì„œë²„ë¼ë„ ì‘ë‹µí•˜ë©´ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€í•¨)
        gun.on('hi', (peer) => {
            sb.innerText = "ğŸŸ¢ ì„œë²„ ì—°ê²° ì„±ê³µ! ê²Œì„ ê°€ëŠ¥";
            sb.classList.add('online');
            console.log("Connected to:", peer.url);
        });

    } catch (e) {
        sb.innerText = "ğŸš¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨";
        dbg.style.display = 'block';
        dbg.innerText = e.message;
    }

    let currentRoomId = new URLSearchParams(window.location.search).get('room');
    if(currentRoomId) {
        document.getElementById('init-view').classList.add('hidden');
        document.getElementById('join-view').classList.remove('hidden');
    }

    function initCreateRoom() {
        if(!sb.classList.contains('online')) {
            alert("ì„œë²„ì™€ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. 10ì´ˆë§Œ ë” ê¸°ë‹¤ë ¤ë³´ì‹œê³  ì•ˆ ë˜ë©´ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            return;
        }
        currentRoomId = 'r' + Math.random().toString(36).substr(2, 5);
        document.getElementById('init-view').classList.add('hidden');
        document.getElementById('join-view').classList.remove('hidden');
    }

    function processJoin() {
        const name = document.getElementById('my-name').value.trim();
        if(!name) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        // ìƒˆ ê²½ë¡œ v50 ì‚¬ìš©
        const room = gun.get('dm_v50_' + currentRoomId);
        const myId = 'u' + Math.random().toString(36).substr(2, 5);
        room.get('players').get(myId).put({ name: name, id: myId });
        
        alert(name + "ë‹˜, ëŒ€ê¸°ì‹¤ë¡œ ì…ì¥í•©ë‹ˆë‹¤! (ì´í›„ ë¡œì§ì€ ë™ì¼)");
    }
</script>
</body>
</html>
