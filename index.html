<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; --dalmuti-color: #f1c40f; --peon-color: #95a5a6; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        #setup, #role-draw, #tax-phase, #game-board, #round-result-screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        #rank-board { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--accent); }
        .rank-badge { display: inline-block; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }
        .badge-dalmuti { background: var(--accent); color: #000; }
        .badge-peon { background: #7f8c8d; color: #fff; }
        .badge-common { background: #34495e; color: #fff; }

        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .card { 
            width: 70px; height: 105px; background: white; border-radius: 8px; 
            border: 2px solid #333; cursor: pointer; overflow: hidden; position: relative;
            display: flex; align-items: center; justify-content: center; color: #2c3e50;
        }
        .card-number { font-size: 32px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; }
        .table-area { min-height: 130px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 15px 0; padding: 10px; border: 1px dashed #555; }
        .hidden { display: none; }
        #status-msg, #tax-msg { color: #2ecc71; font-weight: bold; margin: 10px 0; }
        
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; background: #ecf0f1; color: #2c3e50; transition: 0.2s; }
        input:focus { outline: none; border-color: var(--accent); background: #fff; }

        .finished { opacity: 0.5; text-decoration: line-through; }
        .role-item { margin: 10px 0; font-size: 1.1rem; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); }
        
        /* ë©€í‹° ì ‘ì† ì•ˆë‚´ìš© */
        #conn-status { font-size: 12px; margin-bottom: 10px; padding: 5px; border-radius: 5px; background: #c0392b; font-weight: bold; }
        .online { background: #27ae60 !important; }
    </style>
</head>
<body>
    <div id="conn-status">ğŸ“¡ ì‹ í˜¸ê¸° ì¤€ë¹„ ì¤‘...</div>

    <div id="setup">
        <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
        <div id="host-only">
            <p>ì°¸ê°€ì ì´ë¦„ì„ ì ê³  íŒ€ì›ë“¤ì—ê²Œ ë§í¬ë¥¼ ë³´ë‚´ì„¸ìš”.</p>
            <input type="text" id="player-names" placeholder="ì´ë¦„,ì´ë¦„,ì´ë¦„" autocomplete="off">
            <div id="invite-link" style="font-size:11px; margin:10px 0; word-break:break-all; background:#000; padding:5px; border-radius:5px; display:none;"></div>
            <button onclick="startRoleDrawing()">ì„œì—´ ì •í•˜ê¸° ì‹œì‘</button>
        </div>
        <div id="guest-only" class="hidden">
            <p>ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
            <h3 id="my-name-display" style="color:var(--accent)"></h3>
        </div>
    </div>

    <div id="role-draw" class="hidden">
        <h3>ğŸƒ ì²« ì„œì—´ ì •í•˜ê¸°</h3>
        <p>ì¹´ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”. ëª¨ë‘ ë‹¤ë¥¸ ìˆ«ìê°€ ë‚˜ì˜µë‹ˆë‹¤!</p>
        <div id="role-cards" class="card-container"></div>
        <div id="role-results" style="margin-top:20px;"></div>
        <button id="tax-start-btn" class="hidden" onclick="prepareTaxPhase()">ì„¸ê¸ˆ ë‚©ë¶€ ë‹¨ê³„ë¡œ</button>
    </div>

    <div id="tax-phase" class="hidden">
        <h3>ğŸ’° ì„¸ê¸ˆ ë‚©ë¶€ ë° í•˜ì‚¬</h3>
        <div id="peon-tax-section">
            <p><span id="peon-name" style="color:#bdc3c7"></span> ë†ë…¸ë‹˜, ë‹¬ë¬´í‹°ì—ê²Œ ë°”ì¹  <br><b>ê°€ì¥ ì¢‹ì€ ì¹´ë“œ 2ì¥</b>ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="peon-hand-for-tax" class="card-container"></div>
            <button onclick="submitPeonTax()">ì¡°ê³µ ë°”ì¹˜ê¸°</button>
        </div>
        <div id="dalmuti-tax-section" class="hidden">
            <p><span id="dalmuti-name" style="color:var(--accent)"></span> ë‹¬ë¬´í‹°ë‹˜, ë†ë…¸ì—ê²Œ ì¤„ <br><b>ì•„ë¬´ ì¹´ë“œë‚˜ 2ì¥</b>ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            <div id="dalmuti-hand-for-tax" class="card-container"></div>
            <button onclick="submitDalmutiTax()">ì¹´ë“œ í•˜ì‚¬í•˜ê¸°</button>
        </div>
    </div>

    <div id="game-board" class="hidden">
        <div id="rank-board"></div>
        <div id="turn-indicator" style="font-size:1.2rem; color:#3498db; font-weight:bold; margin-bottom:10px;">ì°¨ë¡€</div>
        <div class="table-area"><div id="last-played-cards" class="card-container"></div></div>
        <div id="status-msg">ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!</div>
        <button id="show-btn" onclick="revealHand()">ë‚´ ì¹´ë“œ í™•ì¸í•˜ê¸°</button>
        <div id="player-hand" class="card-container hidden"></div>
        <div id="actions" class="hidden" style="margin-top:20px;">
            <button onclick="playSelectedCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
        <div id="game-status" style="margin-top:20px; font-size:0.8rem; color:#aaa;"></div>
    </div>

    <div id="round-result-screen" class="hidden">
        <h3>ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ! ìƒˆë¡œìš´ ì„œì—´</h3>
        <div id="final-ranking-list"></div>
        <div style="margin-top:30px;">
            <button onclick="prepareTaxPhase()" style="background:#2ecc71;">ì´ ê²°ê³¼ë¡œ ê³„ì† ì§„í–‰</button>
            <button onclick="location.reload()" style="background:#e74c3c;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

<script>
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    let players = [], currentPlayerIndex = 0, lastPlayed = { rank: 14, count: 0 }, selectedCards = [], passCount = 0;
    let finishOrder = [], taxStorage = [], rankDrawingDeck = [];
    
    // ë©€í‹° í†µì‹  ë³€ìˆ˜
    let peer, connMap = {}, myId, myRole, roomCode;
    const urlParams = new URLSearchParams(window.location.search);
    roomCode = urlParams.get('room');

    // PeerJS ì´ˆê¸°í™”
    peer = new Peer();
    peer.on('open', (id) => {
        myId = id;
        const statusEl = document.getElementById('conn-status');
        statusEl.innerText = "ğŸŸ¢ ì‹ í˜¸ ì¤€ë¹„ ì™„ë£Œ";
        statusEl.classList.add('online');

        if(roomCode) {
            myRole = 'guest';
            document.getElementById('host-only').classList.add('hidden');
            document.getElementById('guest-only').classList.remove('hidden');
            const conn = peer.connect(roomCode);
            setupConn(conn);
        } else {
            myRole = 'host';
            const link = window.location.origin + window.location.pathname + "?room=" + myId;
            const linkDiv = document.getElementById('invite-link');
            linkDiv.innerText = "ì´ˆëŒ€ ë§í¬: " + link;
            linkDiv.style.display = "block";
        }
    });

    peer.on('connection', (conn) => {
        setupConn(conn);
    });

    function setupConn(conn) {
        conn.on('open', () => {
            connMap[conn.peer] = conn;
            if(myRole === 'guest') conn.send({type: 'READY'});
        });
        conn.on('data', (data) => {
            // ë°©ì¥ìœ¼ë¡œë¶€í„° ë°›ì€ ë°ì´í„°ë¡œ ê²Œì„ ìƒíƒœ ë™ê¸°í™”
            if(data.type === 'SYNC') {
                players = data.players;
                currentPlayerIndex = data.currentPlayerIndex;
                lastPlayed = data.lastPlayed;
                finishOrder = data.finishOrder;
                taxStorage = data.taxStorage;
                showScreen(data.screenId);
                if(data.screenId === 'role-draw') renderRoleDrawing();
                if(data.screenId === 'tax-phase') updateTaxUI();
                if(data.screenId === 'game-board') updateUI();
                if(data.screenId === 'round-result-screen') showRoundResult();
            }
            if(data.type === 'NAME_ASSIGN') {
                document.getElementById('my-name-display').innerText = "ë‚´ ì´ë¦„: " + data.name;
            }
        });
    }

    function broadcast(screenId) {
        if(myRole !== 'host') return;
        const data = {
            type: 'SYNC',
            players: players,
            currentPlayerIndex: currentPlayerIndex,
            lastPlayed: lastPlayed,
            finishOrder: finishOrder,
            taxStorage: taxStorage,
            screenId: screenId
        };
        Object.values(connMap).forEach(conn => conn.send(data));
    }

    // --- ì‚¬ìš©ì ì›ë³¸ ë¡œì§ ìœ ì§€í•˜ë©° í†µì‹  ì½”ë“œë§Œ ì‚½ì… ---

    function startRoleDrawing() {
        const val = document.getElementById('player-names').value;
        const names = val.split(',').map(n => n.trim()).filter(n => n !== "");
        if (names.length < 2) return alert("ìµœì†Œ 2ëª… ì´ìƒì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        rankDrawingDeck = Array.from({length: 12}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        players = names.map((name, idx) => ({ 
            name, hand: [], initialRank: 0, isFinished: false, roleTitle: "",
            peerId: (idx === 0) ? myId : Object.keys(connMap)[idx-1]
        }));

        // ê²ŒìŠ¤íŠ¸ë“¤ì—ê²Œ ì´ë¦„ í• ë‹¹ ì•Œë¦¼
        players.forEach(p => {
            if(p.peerId && connMap[p.peerId]) {
                connMap[p.peerId].send({type: 'NAME_ASSIGN', name: p.name});
            }
        });

        renderRoleDrawing();
        showScreen('role-draw');
        broadcast('role-draw');
    }

    function renderRoleDrawing() {
        const container = document.getElementById('role-cards');
        container.innerHTML = '';
        players.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `role-card-${i}`;
            if(p.initialRank > 0) {
                card.innerHTML = `<div class="card-number">${p.initialRank}</div><img src="${IMG_BASE}${p.initialRank}.png" onerror="this.style.display='none'">`;
            } else {
                card.innerHTML = `<div class="card-number">?</div>`;
                // ë°©ì¥ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ í•˜ê±°ë‚˜, ëˆ„êµ¬ë“  í´ë¦­í•˜ë©´ ë™ê¸°í™”
                card.onclick = () => drawOneCard(i);
            }
            container.appendChild(card);
        });
    }

    function drawOneCard(playerIdx) {
        if (players[playerIdx].initialRank > 0) return;
        const assignedRank = rankDrawingDeck.pop();
        players[playerIdx].initialRank = assignedRank;
        
        renderRoleDrawing();
        if (players.every(p => p.initialRank > 0)) {
            players.sort((a, b) => a.initialRank - b.initialRank);
            assignRoles();
            const resultDiv = document.getElementById('role-results');
            resultDiv.innerHTML = "<h4>âœ¨ ìµœì¢… ì„œì—´ âœ¨</h4>" + players.map(p => `<div class="role-item"><b>${p.roleTitle}</b>: ${p.name} (${p.initialRank}ë²ˆ)</div>`).join('');
            document.getElementById('tax-start-btn').classList.remove('hidden');
        }
        broadcast('role-draw');
    }

    function assignRoles() {
        players.forEach((p, i) => {
            if (i === 0) p.roleTitle = "ğŸ‘‘ ìœ„ëŒ€í•œ ë‹¬ë¬´í‹°";
            else if (i === players.length - 1) p.roleTitle = "ğŸ’© ë†ë…¸";
            else p.roleTitle = `${i+1}ë“± í‰ë¯¼`;
            p.isFinished = false;
        });
    }

    function prepareTaxPhase() {
        let deck = [];
        for (let i = 1; i <= 12; i++) for (let j = 0; j < i; j++) deck.push(i);
        deck.push(13, 13);
        deck.sort(() => Math.random() - 0.5);
        players.forEach(p => p.hand = []);
        let i = 0; while (deck.length > 0) players[i++ % players.length].hand.push(deck.pop());
        players.forEach(p => p.hand.sort((a, b) => a - b));
        
        updateTaxUI();
        showScreen('tax-phase');
        broadcast('tax-phase');
    }

    function updateTaxUI() {
        document.getElementById('peon-tax-section').classList.remove('hidden');
        document.getElementById('dalmuti-tax-section').classList.add('hidden');
        const peon = players[players.length - 1];
        const dalmuti = players[0];
        document.getElementById('peon-name').innerText = peon.name;
        document.getElementById('dalmuti-name').innerText = dalmuti.name;

        // í˜„ì¬ ì ‘ì†ìê°€ ëˆ„êµ¬ëƒì— ë”°ë¼ ë³´ì—¬ì§€ëŠ” í•¸ë“œ ê²°ì •
        const me = players.find(p => p.peerId === myId);
        if(me === peon) renderTaxHand('peon-hand-for-tax', peon.hand);
        else if(me === dalmuti) renderTaxHand('dalmuti-hand-for-tax', dalmuti.hand);
    }

    function renderTaxHand(containerId, hand) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        selectedCards = [];
        hand.forEach((rank, idx) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-number">${rank === 13 ? 'J' : rank}</div><img src="${IMG_BASE}${rank}.png" onerror="this.style.display='none'">`;
            card.onclick = () => {
                card.classList.toggle('selected');
                const fIdx = selectedCards.findIndex(c => c.idx === idx);
                if (fIdx > -1) selectedCards.splice(fIdx, 1); else selectedCards.push({ rank, idx });
            };
            container.appendChild(card);
        });
    }

    function submitPeonTax() {
        if(players.find(p => p.peerId === myId) !== players[players.length-1]) return alert("ë†ë…¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if (selectedCards.length !== 2) return alert("ë°˜ë“œì‹œ 2ì¥ì„ ë°”ì³ì•¼ í•©ë‹ˆë‹¤!");
        const peon = players[players.length - 1];
        const bestTwo = [...peon.hand].sort((a,b) => a-b).slice(0, 2);
        const selectedRanks = selectedCards.map(c => c.rank).sort((a,b) => a-b);
        if (!selectedRanks.every((r, i) => r === bestTwo[i])) return alert(`ì–´ë””ì„œ ê°íˆ ê±°ì§“ì„ ê³ í•˜ëŠëƒ. (${bestTwo[0]}ë²ˆ, ${bestTwo[1]}ë²ˆ ì„ íƒ)`);
        
        const indices = selectedCards.map(c => c.idx).sort((a,b)=>b-a);
        taxStorage = indices.map(idx => peon.hand.splice(idx, 1)[0]);
        
        document.getElementById('peon-tax-section').classList.add('hidden');
        document.getElementById('dalmuti-tax-section').classList.remove('hidden');
        renderTaxHand('dalmuti-hand-for-tax', players[0].hand);
        broadcast('tax-phase');
    }

    function submitDalmutiTax() {
        if(players.find(p => p.peerId === myId) !== players[0]) return alert("ë‹¬ë¬´í‹°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        if (selectedCards.length !== 2) return alert("2ì¥ì„ í•˜ì‚¬í•˜ì…”ì•¼ í•©ë‹ˆë‹¤!");
        const dalmuti = players[0], peon = players[players.length - 1];
        const indices = selectedCards.map(c => c.idx).sort((a,b)=>b-a);
        indices.forEach(idx => peon.hand.push(dalmuti.hand.splice(idx, 1)[0]));
        dalmuti.hand.push(...taxStorage);
        players.forEach(p => p.hand.sort((a, b) => a - b));
        taxStorage = [];
        startRealGame();
        broadcast('game-board');
    }

    function startRealGame() {
        const rb = document.getElementById('rank-board');
        rb.innerHTML = "<b>[í˜„ì¬ ì‹ ë¶„ ì„œì—´]</b><br>";
        players.forEach((p, i) => {
            let cls = (i === 0) ? 'badge-dalmuti' : (i === players.length - 1 ? 'badge-peon' : 'badge-common');
            rb.innerHTML += `<span class="rank-badge ${cls}">${p.roleTitle}: ${p.name}</span>`;
        });
        finishOrder = []; lastPlayed = { rank: 14, count: 0 };
        document.getElementById('last-played-cards').innerHTML = '';
        currentPlayerIndex = 0;
        showScreen('game-board');
        updateUI();
    }

    function updateUI() {
        const p = players[currentPlayerIndex];
        document.getElementById('turn-indicator').innerText = `ğŸ“¢ [${p.name}] ì°¨ë¡€ (${p.roleTitle})`;
        document.getElementById('player-hand').classList.add('hidden');
        document.getElementById('show-btn').classList.remove('hidden');
        document.getElementById('actions').classList.add('hidden');
        document.getElementById('status-msg').innerText = lastPlayed.count > 0 ? `${lastPlayed.rank}ë²ˆë³´ë‹¤ ë†’ì€ ê³„ê¸‰ ${lastPlayed.count}ì¥ì„ ë‚´ì„¸ìš”.` : "ìƒˆ ë¼ìš´ë“œ ì‹œì‘!";
        document.getElementById('game-status').innerHTML = players.map(p => `<span class="${p.isFinished ? 'finished' : ''}">${p.name}(${p.hand.length})</span>`).join(' | ');
        selectedCards = [];

        // ë‚´ ì°¨ë¡€ì¼ ë•Œë§Œ ë²„íŠ¼ í™œì„±í™”
        if(p.peerId === myId) {
            document.getElementById('show-btn').disabled = false;
        } else {
            document.getElementById('show-btn').disabled = true;
        }
    }

    function revealHand() {
        const p = players[currentPlayerIndex];
        if(p.peerId !== myId) return; // ë‚´ í•¸ë“œë§Œ í™•ì¸ ê°€ëŠ¥
        const handDiv = document.getElementById('player-hand');
        handDiv.innerHTML = '';
        p.hand.forEach((rank, idx) => {
            handDiv.innerHTML += `<div class="card" onclick="toggleCard(this, ${rank}, ${idx})"><div class="card-number">${rank === 13 ? 'J' : rank}</div><img src="${IMG_BASE}${rank}.png" onerror="this.style.display='none'"></div>`;
        });
        handDiv.classList.remove('hidden');
        document.getElementById('actions').classList.remove('hidden');
    }

    function toggleCard(el, rank, idx) {
        el.classList.toggle('selected');
        const fIdx = selectedCards.findIndex(c => c.idx === idx);
        if (fIdx > -1) selectedCards.splice(fIdx, 1); else selectedCards.push({ rank, idx });
    }

    function playSelectedCards() {
        if (selectedCards.length === 0) return;
        const rank = selectedCards[0].rank;
        if (!selectedCards.every(c => c.rank === rank || c.rank === 13)) return alert("ê°™ì€ ì¹´ë“œë§Œ ê°€ëŠ¥!");
        if (lastPlayed.count === 0 || (selectedCards.length === lastPlayed.count && rank < lastPlayed.rank)) {
            lastPlayed = { rank, count: selectedCards.length };
            const toRem = selectedCards.map(c => c.idx).sort((a,b)=>b-a);
            toRem.forEach(idx => players[currentPlayerIndex].hand.splice(idx, 1));
            
            // ê³µìš© ë°”ë‹¥ í™”ë©´ ì—…ë°ì´íŠ¸
            const table = document.getElementById('last-played-cards');
            table.innerHTML = '';
            selectedCards.forEach(c => table.innerHTML += `<div class="card"><div class="card-number">${c.rank === 13 ? 'J' : c.rank}</div><img src="${IMG_BASE}${c.rank}.png" onerror="this.style.display='none'"></div>`);
            
            if (players[currentPlayerIndex].hand.length === 0) {
                players[currentPlayerIndex].isFinished = true;
                finishOrder.push(players[currentPlayerIndex]);
            }
            passCount = 0; moveToNext();
            broadcast('game-board');
        } else { alert("ì¡°ê±´ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
    }

    function passTurn() {
        passCount++;
        if (passCount >= players.filter(p => !p.isFinished).length) {
            lastPlayed = { rank: 14, count: 0 };
            document.getElementById('last-played-cards').innerHTML = 'ë°”ë‹¥ ì²­ì†Œë¨';
            passCount = 0;
        }
        moveToNext();
        broadcast('game-board');
    }

    function moveToNext() {
        const active = players.filter(p => !p.isFinished);
        if (active.length <= 1) {
            if (active.length === 1) finishOrder.push(active[0]);
            players = [...finishOrder]; 
            assignRoles();
            showRoundResult(); 
            broadcast('round-result-screen');
            return;
        }
        do { currentPlayerIndex = (currentPlayerIndex + 1) % players.length; } while (players[currentPlayerIndex].isFinished);
        updateUI();
    }

    function showRoundResult() {
        showScreen('round-result-screen');
        const listDiv = document.getElementById('final-ranking-list');
        listDiv.innerHTML = players.map((p, i) => `
            <div class="role-item">
                <span style="font-weight:bold; color:var(--accent);">${i+1}ìœ„</span>: 
                ${p.name} <span style="font-size:0.9rem; color:#aaa;">(${p.roleTitle})</span>
            </div>
        `).join('');
    }

    function showScreen(id) {
        ['setup', 'role-draw', 'tax-phase', 'game-board', 'round-result-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
