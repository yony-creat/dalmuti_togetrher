<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° - ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; --dalmuti-color: #f1c40f; --peon-color: #95a5a6; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; border: 1px solid #34495e; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; min-height: 110px; }
        .card { width: 65px; height: 95px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; color: #2c3e50; overflow: hidden; }
        .card-number { font-size: 28px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        .hidden { display: none; }
        .role-item { margin: 10px 0; font-size: 1.1rem; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); }
        #status-bar { padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; background: #c0392b; font-weight: bold; }
        .online { background: #27ae60 !important; }
    </style>
</head>
<body>
    <div id="status-bar">ğŸ“¡ ë¬´ì „ê¸° ì£¼íŒŒìˆ˜ ë§ì¶”ëŠ” ì¤‘...</div>

    <div id="setup-screen" class="screen">
        <div id="host-view">
            <button onclick="beHost()">ğŸ° ë‚´ê°€ ë°©ì¥ (ë°© ë§Œë“¤ê¸°)</button>
        </div>
        <div id="join-view" class="hidden">
            <input type="text" id="user-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding:10px; width:80%; margin-bottom:10px; color:#000;">
            <button onclick="beGuest()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="round-result-screen" class="screen hidden">
        <h3>ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ! ìƒˆë¡œìš´ ì„œì—´</h3>
        <div id="final-ranking-list"></div>
        <div style="margin-top:30px;">
            <button id="next-round-btn" class="hidden" onclick="hostStartTax()" style="background:#2ecc71;">ì´ ê²°ê³¼ë¡œ ê³„ì† ì§„í–‰ (ì„¸ê¸ˆ ë‹¨ê³„)</button>
            <button onclick="location.reload()" style="background:#e74c3c;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ í•˜ê¸° (ìƒˆë¡œê³ ì¹¨)</button>
        </div>
    </div>

    <div id="game-board" class="screen hidden">
        <div id="rank-display"></div>
        <div id="turn-info" style="color:var(--accent); font-weight:bold; margin:10px 0;"></div>
        <div id="table" class="card-container" style="background:rgba(255,255,255,0.05); border-radius:10px;"></div>
        <div id="hand" class="card-container"></div>
        <div id="game-controls" class="hidden">
            <button onclick="playSelected()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

<script>
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    let peer = new Peer({ config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });
    let connMap = {}, myRole, myHand = [], selected = [], myId;
    let gameState = { players: [], finishOrder: [], turn: 0, lastMove: {rank:14, count:0}, status: 'lobby' };
    const roomCode = new URLSearchParams(window.location.search).get('room');

    peer.on('open', (id) => {
        myId = id; document.getElementById('status-bar').innerText = "ğŸŸ¢ ì ‘ì† ì¤€ë¹„ ì™„ë£Œ";
        document.getElementById('status-bar').classList.add('online');
        if(roomCode) { document.getElementById('host-view').classList.add('hidden'); document.getElementById('join-view').classList.remove('hidden'); }
    });

    function beHost() {
        myRole = 'host'; const name = prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "ë°©ì¥");
        gameState.players.push({id: myId, name, roleTitle: 'ì‹¬ì‚¬ì¤‘', cards: 0, isFinished: false});
        showScreen('setup-screen'); // ëŒ€ê¸° í™”ë©´ ìœ ì§€
        peer.on('connection', (c) => {
            c.on('open', () => { c.on('data', (data) => handleData(data, c)); });
        });
        alert("íŒ€ì›ë“¤ì—ê²Œ ì´ˆëŒ€ ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”!");
    }

    function beGuest() {
        myRole = 'guest'; const name = document.getElementById('user-name').value;
        const conn = peer.connect(roomCode);
        conn.on('open', () => {
            conn.send({type: 'JOIN', name});
            conn.on('data', (data) => handleData(data, conn));
        });
        connMap[roomCode] = conn;
    }

    function handleData(data, conn) {
        if(data.type === 'JOIN') {
            gameState.players.push({id: conn.peer, name: data.name, roleTitle: 'ì‹¬ì‚¬ì¤‘', cards: 0, isFinished: false});
            broadcast({type: 'SYNC', state: gameState});
            alert(data.name + "ë‹˜ ì…ì¥!");
        }
        if(data.type === 'SYNC') { gameState = data.state; if(data.hand) myHand = data.hand; updateGameUI(); }
        if(data.type === 'FINISH') { 
            const p = gameState.players.find(x => x.id === data.uid);
            p.isFinished = true;
            if(!gameState.finishOrder.includes(data.uid)) gameState.finishOrder.push(data.uid);
            checkRoundOver();
        }
    }

    function checkRoundOver() {
        const active = gameState.players.filter(p => !p.isFinished);
        if(active.length <= 1) {
            if(active.length === 1) gameState.finishOrder.push(active[0].id);
            // ì„œì—´ ì¬ë°°ì •
            let newPlayers = [];
            gameState.finishOrder.forEach((id, idx) => {
                let p = gameState.players.find(x => x.id === id);
                if(idx === 0) p.roleTitle = "ğŸ‘‘ ìœ„ëŒ€í•œ ë‹¬ë¬´í‹°";
                else if(idx === gameState.players.length-1) p.roleTitle = "ğŸ’© ë†ë…¸";
                else p.roleTitle = (idx+1) + "ë“± í‰ë¯¼";
                newPlayers.push(p);
            });
            gameState.players = newPlayers;
            gameState.status = 'result';
            broadcast({type: 'SYNC', state: gameState});
            showResultScreen();
        }
    }

    function showResultScreen() {
        showScreen('round-result-screen');
        const listDiv = document.getElementById('final-ranking-list');
        listDiv.innerHTML = gameState.players.map((p, i) => `
            <div class="role-item"><b>${i+1}ìœ„</b>: ${p.name} (${p.roleTitle})</div>
        `).join('');
        if(myRole === 'host') document.getElementById('next-round-btn').classList.remove('hidden');
    }

    function hostStartTax() {
        // ê²°ê³¼ ì—°ê²° í›„ ì„¸ê¸ˆ ë‹¨ê³„ë¡œ ì´ë™
        gameState.status = 'playing';
        gameState.finishOrder = [];
        gameState.players.forEach(p => p.isFinished = false);
        
        let deck = []; for(let i=1; i<=12; i++) for(let j=0; j<i; j++) deck.push(i);
        deck.push(13, 13); deck.sort(() => Math.random() - 0.5);
        
        gameState.players.forEach((p, idx) => {
            let hand = []; for(let i=idx; i<deck.length; i+=gameState.players.length) hand.push(deck[i]);
            if(p.id === myId) myHand = hand;
            else { if(connMap[p.id]) connMap[p.id].send({type: 'SYNC', state: gameState, hand}); }
        });
        showScreen('game-board'); updateGameUI();
    }

    function updateGameUI() {
        if(gameState.status === 'result') return showResultScreen();
        showScreen('game-board');
        const tp = gameState.players[gameState.turn];
        document.getElementById('turn-info').innerText = tp.id === myId ? "â­ ë‚´ ì°¨ë¡€!" : `ğŸ“¢ [${tp.name}] ì°¨ë¡€`;
        document.getElementById('game-controls').classList.toggle('hidden', tp.id !== myId);
        
        renderHand();
        document.getElementById('table').innerHTML = "";
        for(let i=0; i<gameState.lastMove.count; i++) {
            document.getElementById('table').innerHTML += `<div class="card"><img src="${IMG_BASE}${gameState.lastMove.rank}.png"></div>`;
        }
    }

    function renderHand() {
        const div = document.getElementById('hand'); div.innerHTML = "";
        myHand.sort((a,b)=>a-b).forEach((r, i) => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<img src="${IMG_BASE}${r}.png">`;
            c.onclick = () => { c.classList.toggle('selected'); const sIdx = selected.findIndex(s => s.i === i); if(sIdx>-1) selected.splice(sIdx,1); else selected.push({r, i}); };
            div.appendChild(c);
        });
        selected = [];
    }

    function playSelected() {
        const rank = selected[0].r;
        if(gameState.lastMove.count === 0 || (selected.length === gameState.lastMove.count && rank < gameState.lastMove.rank)) {
            gameState.lastMove = {rank, count: selected.length};
            selected.sort((a,b)=>b.i-a.i).forEach(s => myHand.splice(s.i, 1));
            if(myHand.length === 0) broadcast({type: 'FINISH', uid: myId});
            nextTurn();
        }
    }

    function nextTurn() {
        do { gameState.turn = (gameState.turn + 1) % gameState.players.length; } while(gameState.players[gameState.turn].isFinished);
        broadcast({type: 'SYNC', state: gameState}); updateGameUI();
    }

    function passTurn() { nextTurn(); }
    function broadcast(data) { Object.values(connMap).forEach(c => c.send(data)); }
    function showScreen(id) {
        ['setup-screen', 'round-result-screen', 'game-board'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
