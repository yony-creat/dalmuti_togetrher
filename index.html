<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ì˜¨ë¼ì¸ - ì„œë²„ ê¸´ê¸‰ ë³µêµ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; border: 1px solid #34495e; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        #status-bar { padding: 10px; margin-bottom: 15px; border-radius: 10px; font-size: 14px; background: #c0392b; font-weight: bold; transition: 0.3s; }
        .online { background: #27ae60 !important; }
        .hidden { display: none; }
        .player-tag { background: #34495e; padding: 8px 15px; border-radius: 20px; margin: 5px; display: inline-block; border: 1px solid var(--accent); }
    </style>
</head>
<body>
    <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´</h2>
    <div id="status-bar">ğŸ”´ ì„œë²„ í†µë¡œ ì°¾ëŠ” ì¤‘ (ì•½ 10ì´ˆ ì†Œìš”)</div>

    <div id="setup-screen" class="screen">
        <div id="init-view">
            <button onclick="initCreateRoom()">â• ìƒˆ ë°© ë§Œë“¤ê¸°</button>
            <p style="font-size: 12px; color: #888; margin-top: 10px;">ìƒíƒœ ë°”ê°€ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€í•˜ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
        </div>
        <div id="join-view" class="hidden">
            <input type="text" id="my-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" autocomplete="off">
            <button onclick="processJoin()">ê²Œì„ ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <div style="background: #34495e; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
            ğŸ  ë°© ì½”ë“œ: <b id="display-room-id" style="color:var(--accent)"></b>
        </div>
        <div id="lobby-players" style="margin-bottom:20px; min-height: 60px;"></div>
        <button onclick="startGame()">í”Œë ˆì´ì–´ ì…ì¥ í™•ì¸! ì‹œì‘</button>
    </div>

<script>
    const sb = document.getElementById('status-bar');
    
    // [ì¤‘ìš”] ê¸°ì¡´ ì‹¤íŒ¨í•œ ì£¼ì†Œ ì œì™¸, í˜„ì¬ ë™ì‘ í™•ì¸ëœ ìƒˆë¡œìš´ ì„œë²„ ì£¼ì†Œë“¤
    const gun = Gun({
        peers: [
            'https://gun-us.herokuapp.com/gun',
            'https://gun-eu.herokuapp.com/gun',
            'https://gun-server.herokuapp.com/gun'
        ],
        localStorage: false
    });

    // ì—°ê²° ì„±ê³µ ê°ì§€
    gun.on('hi', () => {
        sb.innerText = "ğŸŸ¢ ì„œë²„ ì—°ê²° ì„±ê³µ! ê²Œì„ ì‹œì‘ ê°€ëŠ¥";
        sb.classList.add('online');
    });

    let currentRoomId = new URLSearchParams(window.location.search).get('room');
    if(currentRoomId) {
        document.getElementById('init-view').classList.add('hidden');
        document.getElementById('join-view').classList.remove('hidden');
    }

    function initCreateRoom() {
        if(!sb.classList.contains('online')) return alert("ì•„ì§ ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ë” ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
        currentRoomId = 'rm' + Math.random().toString(36).substr(2, 5);
        document.getElementById('init-view').classList.add('hidden');
        document.getElementById('join-view').classList.remove('hidden');
    }

    function processJoin() {
        const name = document.getElementById('my-name').value.trim();
        if(!name) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        const myId = 'u' + Math.random().toString(36).substr(2, 5);
        const room = gun.get('dalmuti_v30_stable_' + currentRoomId);
        
        room.get('players').get(myId).put({ name: name, id: myId });
        document.getElementById('display-room-id').innerText = currentRoomId;
        showScreen('lobby-screen');

        room.get('players').map().on((data, id) => {
            if (data && data.name) {
                const lobby = document.getElementById('lobby-players');
                if(!document.getElementById('p-' + id)) {
                    lobby.innerHTML += `<div id="p-${id}" class="player-tag">ğŸ‘¤ ${data.name}</div>`;
                }
            }
        });

        room.get('state').on(s => {
            if(s) { /* ê²Œì„ ì‹œì‘ ë¡œì§ */ alert("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"); }
        });
    }

    function showScreen(id) {
        ['setup-screen', 'lobby-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
