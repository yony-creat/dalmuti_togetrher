<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° - í•¨ê»˜í•˜ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .card { 
            width: 65px; height: 95px; background: white; border-radius: 8px; 
            border: 2px solid #333; cursor: pointer; overflow: hidden; position: relative;
            display: flex; align-items: center; justify-content: center; color: #2c3e50;
        }
        .card-number { font-size: 28px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; }
        .hidden { display: none; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: none; font-size: 16px; margin-bottom: 10px; text-align: center; }
        #rank-board { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.9rem; border: 1px solid var(--accent); }
    </style>
</head>
<body>
    <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹° (ë©€í‹° ëª¨ë“œ)</h2>

    <div id="setup-screen" class="screen">
        <input type="text" id="room-id" placeholder="ë°© ì´ë¦„ (ëª¨ë‘ ë˜‘ê°™ì´ ì…ë ¥)">
        <input type="text" id="my-name" placeholder="ë‚´ ì´ë¦„">
        <button onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h3>ëŒ€ê¸°ì‹¤</h3>
        <p>í•¨ê»˜í•  ì‚¬ëŒë“¤ì´ ëª¨ë‘ ë“¤ì–´ì˜¤ë©´ ì‹œì‘í•˜ì„¸ìš”.</p>
        <div id="lobby-players" style="margin-bottom:20px;"></div>
        <button id="start-btn" onclick="hostStartGame()">ëª¨ë‘ ì¤€ë¹„ë¨! ì‹œì‘</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="rank-board"></div>
        <div id="turn-info" style="color:#3498db; font-weight:bold; margin-bottom:10px;">ì°¨ë¡€ ëŒ€ê¸° ì¤‘...</div>
        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; min-height:110px;">
            <div id="table-cards" class="card-container"></div>
        </div>
        <div id="my-hand" class="card-container"></div>
        <div id="game-controls">
            <button onclick="playCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']); // ê³µìš© ì„œë²„ ì‚¬ìš©
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    
    let room, myName, myId, gameState = {};
    let selectedCards = [];

    function joinGame() {
        const rId = document.getElementById('room-id').value.trim();
        myName = document.getElementById('my-name').value.trim();
        if(!rId || !myName) return alert("ë°© ì´ë¦„ê³¼ ë‚´ ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”.");
        
        myId = Math.random().toString(36).substr(2, 9);
        room = gun.get('dalmuti_room_' + rId);
        
        // ë‚´ ì •ë³´ ë“±ë¡
        room.get('players').get(myId).put({ name: myName, id: myId, isReady: true });
        
        showScreen('lobby-screen');
        listenToRoom();
    }

    function listenToRoom() {
        // í”Œë ˆì´ì–´ ëª©ë¡ ê°ì‹œ
        room.get('players').map().on((data) => {
            if(data) updateLobbyUI();
        });

        // ê²Œì„ ìƒíƒœ ê°ì‹œ
        room.get('state').on((state) => {
            if(!state) return;
            gameState = JSON.parse(state);
            if(gameState.status === 'playing') {
                showScreen('game-screen');
                renderGame();
            }
        });
    }

    function updateLobbyUI() {
        const lobby = document.getElementById('lobby-players');
        lobby.innerHTML = "";
        room.get('players').map().once((p) => {
            if(p) lobby.innerHTML += `<div>ğŸ‘¤ ${p.name} ì ‘ì† ì™„ë£Œ</div>`;
        });
    }

    function hostStartGame() {
        // í˜¸ìŠ¤íŠ¸(ë¨¼ì € ëˆ„ë¥¸ ì‚¬ëŒ)ê°€ ì¹´ë“œ ë¶„ë°° ë° ìƒíƒœ ì´ˆê¸°í™”
        let playerList = [];
        room.get('players').once((data) => {
            Object.keys(data).forEach(k => { if(data[k] && data[k].name) playerList.push(data[k]); });
            
            let deck = [];
            for (let i = 1; i <= 12; i++) for (let j = 0; j < i; j++) deck.push(i);
            deck.push(13, 13);
            deck.sort(() => Math.random() - 0.5);

            let hands = {};
            playerList.forEach(p => hands[p.id] = []);
            let idx = 0;
            while(deck.length > 0) hands[playerList[idx++ % playerList.length].id].push(deck.pop());

            const initialState = {
                status: 'playing',
                players: playerList,
                hands: hands,
                turnIdx: 0,
                lastPlayed: { rank: 14, count: 0, cards: [] },
                passCount: 0,
                finished: []
            };
            room.get('state').put(JSON.stringify(initialState));
        });
    }

    function renderGame() {
        const me = gameState.players[gameState.turnIdx];
        document.getElementById('turn-info').innerText = `ğŸ“¢ [${me.name}] ë‹˜ì˜ ì°¨ë¡€`;
        
        // ë‚´ íŒ¨ ê·¸ë¦¬ê¸°
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        const myHand = gameState.hands[myId] || [];
        myHand.sort((a,b)=>a-b).forEach((rank, idx) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-number">${rank === 13 ? 'J' : rank}</div><img src="${IMG_BASE}${rank}.png" onerror="this.style.display='none'">`;
            card.onclick = () => {
                card.classList.toggle('selected');
                const fIdx = selectedCards.findIndex(c => c.idx === idx);
                if (fIdx > -1) selectedCards.splice(fIdx, 1); else selectedCards.push({ rank, idx });
            };
            handDiv.appendChild(card);
        });

        // ë°”ë‹¥ ì¹´ë“œ ê·¸ë¦¬ê¸°
        const tableDiv = document.getElementById('table-cards');
        tableDiv.innerHTML = "";
        gameState.lastPlayed.cards.forEach(rank => {
            tableDiv.innerHTML += `<div class="card"><div class="card-number">${rank === 13 ? 'J' : rank}</div><img src="${IMG_BASE}${rank}.png" onerror="this.style.display='none'"></div>`;
        });

        // ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€
        const isMyTurn = (me.id === myId);
        document.getElementById('game-controls').classList.toggle('hidden', !isMyTurn);
    }

    function playCards() {
        if(selectedCards.length === 0) return;
        const rank = selectedCards[0].rank;
        if(!selectedCards.every(c => c.rank === rank || c.rank === 13)) return alert("ê°™ì€ ì¹´ë“œë§Œ ê°€ëŠ¥!");
        
        const count = selectedCards.length;
        if(gameState.lastPlayed.count === 0 || (count === gameState.lastPlayed.count && rank < gameState.lastPlayed.rank)) {
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            gameState.lastPlayed = { rank, count, cards: selectedCards.map(c => c.rank) };
            
            // íŒ¨ì—ì„œ ì œê±°
            const toRem = selectedCards.map(c => c.idx).sort((a,b)=>b-a);
            toRem.forEach(i => gameState.hands[myId].splice(i, 1));
            
            if(gameState.hands[myId].length === 0) alert("íƒˆì¶œ ì„±ê³µ!");

            gameState.passCount = 0;
            nextTurn();
        } else {
            alert("ì¡°ê±´ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }

    function passTurn() {
        gameState.passCount++;
        if(gameState.passCount >= gameState.players.length - 1) {
            gameState.lastPlayed = { rank: 14, count: 0, cards: [] };
            gameState.passCount = 0;
        }
        nextTurn();
    }

    function nextTurn() {
        gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length;
        room.get('state').put(JSON.stringify(gameState));
    }

    function showScreen(id) {
        ['setup-screen', 'lobby-screen', 'game-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
