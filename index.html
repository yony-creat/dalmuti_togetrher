<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° - ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 15px; border-radius: 15px; max-width: 500px; margin: 10px auto; border: 1px solid #34495e; }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 10px 0; min-height: 110px; }
        .card { width: 65px; height: 95px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; position: relative; color: #2c3e50; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-number { font-size: 28px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        #status-bar { padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; background: #c0392b; font-weight: bold; }
        .online { background: #27ae60 !important; }
        .hidden { display: none; }
        .rank-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; margin: 3px; border: 1px solid var(--accent); background: #34495e; }
        #log { font-size: 10px; color: #0f0; background: #000; padding: 5px; height: 50px; overflow-y: auto; text-align: left; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="status-bar">ğŸ“¡ ë¬´ì „ê¸° ì£¼íŒŒìˆ˜ ë§ì¶”ëŠ” ì¤‘...</div>

    <div id="setup-screen" class="screen">
        <div id="host-view">
            <button onclick="startAsHost()">ğŸ° ë‚´ê°€ ë°©ì¥ (ë°© ë§Œë“¤ê¸°)</button>
        </div>
        <div id="join-view" class="hidden">
            <input type="text" id="p-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding:10px; width:70%; border-radius:5px; border:none; margin-bottom:10px;">
            <button onclick="startAsGuest()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <div id="invite-box" class="hidden">
            <p style="font-size:12px;">ğŸ”— ì•„ë˜ ë§í¬ë¥¼ ì§€ì—°ë‹˜ê»˜ ë³´ë‚´ì„¸ìš”!</p>
            <div id="url-link" style="background:#000; padding:8px; font-size:10px; word-break:break-all; cursor:pointer;" onclick="copyLink()"></div>
        </div>
        <h3>ğŸ‘¥ ì°¸ê°€ì ëª©ë¡</h3>
        <div id="player-list"></div>
        <button id="draw-btn" class="hidden" onclick="hostStartDraw()">ğŸƒ ì„œì—´ ì •í•˜ê¸° ì¹´ë“œ ë½‘ê¸° ì‹œì‘</button>
        
        <div id="role-draw-area" class="hidden">
            <p>ì¹´ë“œë¥¼ í•œ ì¥ ê³¨ë¼ì£¼ì„¸ìš”!</p>
            <div id="role-cards" class="card-container"></div>
        </div>
    </div>

    <div id="game-board" class="screen hidden">
        <div id="rank-display"></div>
        <div id="turn-info" style="color:var(--accent); font-weight:bold; margin:10px 0;"></div>
        <div id="table" class="card-container" style="background:rgba(255,255,255,0.05); border-radius:10px;"></div>
        <div id="hand" class="card-container"></div>
        <div id="actions" class="hidden">
            <button onclick="playCards()" style="width:45%">ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d; width:45%">íŒ¨ìŠ¤</button>
        </div>
    </div>

    <div id="log"></div>

<script>
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    const sb = document.getElementById('status-bar');
    const logDiv = document.getElementById('log');
    function log(m) { logDiv.innerHTML += `> ${m}<br>`; logDiv.scrollTop = logDiv.scrollHeight; }

    let peer = new Peer({ config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });
    let connMap = {}, myRole, myHand = [], selected = [], gameState = { players: [], status: 'lobby', turn: 0, lastPlayed: {rank:14, count:0} };
    const roomID = new URLSearchParams(window.location.search).get('room');

    peer.on('open', (id) => {
        sb.innerText = "ğŸŸ¢ ì‹ í˜¸ ì¤€ë¹„ ì™„ë£Œ"; sb.classList.add('online');
        log("ë‚´ í†µì‹  ID: " + id);
        if(roomID) { document.getElementById('host-view').classList.add('hidden'); document.getElementById('join-view').classList.remove('hidden'); }
    });

    // ë°©ì¥ ë¡œì§
    function startAsHost() {
        myRole = 'host';
        const name = prompt("ì‚¬ìš©í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", "ë°©ì¥");
        gameState.players.push({id: peer.id, name, rank: 0, role: 'ì‹¬ì‚¬ì¤‘'});
        
        const link = window.location.origin + window.location.pathname + "?room=" + peer.id;
        document.getElementById('url-link').innerText = link;
        document.getElementById('invite-box').classList.remove('hidden');
        showScreen('lobby-screen');
        updatePlayerList();

        peer.on('connection', (c) => {
            c.on('open', () => {
                c.on('data', (data) => handleData(data, c));
            });
        });
    }

    // ì°¸ê°€ì ë¡œì§
    function startAsGuest() {
        myRole = 'guest';
        const name = document.getElementById('p-name').value || "ì°¸ê°€ì";
        const conn = peer.connect(roomID);
        conn.on('open', () => {
            conn.send({type: 'JOIN', name});
            showScreen('lobby-screen');
            conn.on('data', (data) => handleData(data, conn));
        });
        connMap[roomID] = conn;
    }

    function handleData(data, conn) {
        if(data.type === 'JOIN') {
            if(!connMap[conn.peer]) {
                connMap[conn.peer] = conn;
                gameState.players.push({id: conn.peer, name: data.name, rank: 0, role: 'ì‹¬ì‚¬ì¤‘'});
                broadcast({type: 'LOBBY_SYNC', players: gameState.players});
                updatePlayerList();
                document.getElementById('draw-btn').classList.remove('hidden');
            }
        }
        if(data.type === 'LOBBY_SYNC') { gameState.players = data.players; updatePlayerList(); }
        if(data.type === 'START_DRAW') { startRoleDraw(); }
        if(data.type === 'DRAW_RESULT') {
            const p = gameState.players.find(x => x.id === conn.peer);
            p.rank = data.rank;
            checkAllDrawn();
        }
        if(data.type === 'GAME_START') {
            myHand = data.hand; gameState = data.state;
            showScreen('game-board'); renderGame();
        }
        if(data.type === 'SYNC') { gameState = data.state; renderGame(); }
    }

    function updatePlayerList() {
        document.getElementById('player-list').innerHTML = gameState.players.map(p => `<span class="rank-badge">ğŸ‘¤ ${p.name}</span>`).join('');
    }

    // ì„œì—´ ì •í•˜ê¸° (ë°©ì¥ì´ ì‹œì‘)
    function hostStartDraw() {
        broadcast({type: 'START_DRAW'});
        startRoleDraw();
    }

    function startRoleDraw() {
        document.getElementById('role-draw-area').classList.remove('hidden');
        const container = document.getElementById('role-cards');
        container.innerHTML = '';
        for(let i=0; i<5; i++) {
            container.innerHTML += `<div class="card" onclick="pickRoleCard(this)"><div class="card-number">?</div></div>`;
        }
    }

    function pickRoleCard(el) {
        const myRank = Math.floor(Math.random() * 12) + 1;
        el.innerHTML = `<div class="card-number">${myRank}</div><img src="${IMG_BASE}${myRank}.png">`;
        if(myRole === 'host') {
            gameState.players.find(p => p.id === peer.id).rank = myRank;
            checkAllDrawn();
        } else {
            connMap[roomID].send({type: 'DRAW_RESULT', rank: myRank});
        }
    }

    function checkAllDrawn() {
        if(gameState.players.every(p => p.rank > 0)) {
            gameState.players.sort((a,b) => a.rank - b.rank);
            gameState.players.forEach((p, i) => {
                if(i===0) p.role = "ì™•(ë‹¬ë¬´í‹°)";
                else if(i===gameState.players.length-1) p.role = "ë˜¥(ë†ë…¸)";
                else p.role = (i+1) + "ë“± í‰ë¯¼";
            });
            initRealGame();
        }
    }

    function initRealGame() {
        let deck = [];
        for(let i=1; i<=12; i++) for(let j=0; j<i; j++) deck.push(i);
        deck.push(13, 13); deck.sort(() => Math.random() - 0.5);
        
        gameState.players.forEach((p, idx) => {
            let hand = [];
            for(let i=idx; i<deck.length; i+=gameState.players.length) hand.push(deck[i]);
            if(p.id === peer.id) myHand = hand;
            else connMap[p.id].send({type: 'GAME_START', hand, state: gameState});
        });
        showScreen('game-board'); renderGame();
    }

    function renderGame() {
        const tp = gameState.players[gameState.turn];
        document.getElementById('turn-info').innerText = tp.id === peer.id ? "â­ ë‚´ ì°¨ë¡€!" : `ğŸ“¢ [${tp.name}] ì°¨ë¡€`;
        document.getElementById('rank-display').innerHTML = gameState.players.map(p => `<span class="rank-badge">${p.role}: ${p.name}</span>`).join('');
        document.getElementById('actions').classList.toggle('hidden', tp.id !== peer.id);
        
        const table = document.getElementById('table'); table.innerHTML = "";
        for(let i=0; i<gameState.lastPlayed.count; i++) {
            table.innerHTML += `<div class="card"><img src="${IMG_BASE}${gameState.lastPlayed.rank}.png"></div>`;
        }

        const handDiv = document.getElementById('hand'); handDiv.innerHTML = "";
        myHand.sort((a,b)=>a-b).forEach((r, i) => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<img src="${IMG_BASE}${r}.png">`;
            c.onclick = () => { c.classList.toggle('selected'); const sIdx = selected.findIndex(s => s.i === i); if(sIdx>-1) selected.splice(sIdx,1); else selected.push({r, i}); };
            handDiv.appendChild(c);
        });
        selected = [];
    }

    function playCards() {
        if(selected.length === 0) return;
        const rank = selected[0].r;
        if(gameState.lastPlayed.count === 0 || (selected.length === gameState.lastPlayed.count && rank < gameState.lastPlayed.rank)) {
            gameState.lastPlayed = {rank, count: selected.length};
            selected.sort((a,b)=>b.i-a.i).forEach(s => myHand.splice(s.i, 1));
            gameState.turn = (gameState.turn + 1) % gameState.players.length;
            broadcast({type: 'SYNC', state: gameState}); renderGame();
        }
    }

    function passTurn() {
        gameState.turn = (gameState.turn + 1) % gameState.players.length;
        broadcast({type: 'SYNC', state: gameState}); renderGame();
    }

    function broadcast(data) { Object.values(connMap).forEach(c => c.send(data)); }
    function showScreen(id) {
        ['setup-screen', 'lobby-screen', 'game-board'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function copyLink() { navigator.clipboard.writeText(document.getElementById('url-link').innerText); alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!"); }
</script>
</body>
</html>
