<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° - ë©€í‹° ê°•í™” ë²„ì „</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .card { width: 65px; height: 95px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; color: #2c3e50; overflow: hidden; }
        .card-number { font-size: 28px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; background: #ecf0f1; color: #2c3e50; }
        input:focus::placeholder { color: transparent; }
        .hidden { display: none; }
        #rank-board { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 0.8rem; border: 1px solid var(--accent); }
        #conn-status { font-size: 0.7rem; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
    <div id="conn-status">ì„œë²„ ì—°ê²° ì‹œë„ ì¤‘...</div>

    <div id="setup-screen" class="screen">
        <p>ê°€ì¡± ëª¨ë‘ ê°™ì€ ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="text" id="room-id" placeholder="ë°© ì´ë¦„ (ì˜ˆ: ë‹¬ë¬´í‹°1)" autocomplete="off">
        <input type="text" id="my-name" placeholder="ë‚´ ì´ë¦„" autocomplete="off">
        <button onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h3>ëŒ€ê¸°ì‹¤</h3>
        <p style="font-size:0.8rem; color:#aaa;">ìƒëŒ€ë°©ì´ ì•ˆ ë³´ì´ë©´ ì™€ì´íŒŒì´ë¥¼ ë„ê³  ì ‘ì†í•´ ë³´ì„¸ìš”.</p>
        <div id="lobby-players" style="margin-bottom:20px; min-height: 50px;"></div>
        <button id="start-btn" onclick="hostStartGame()">ëª¨ë‘ ëª¨ì„! ì‹œì‘</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="rank-board"></div>
        <div id="turn-info" style="color:#3498db; font-weight:bold; margin-bottom:10px;">ì°¨ë¡€ ëŒ€ê¸°...</div>
        <div id="table-cards" class="card-container" style="background:rgba(255,255,255,0.05); min-height:100px; border-radius:10px;"></div>
        <div id="my-hand" class="card-container"></div>
        <div id="controls" class="hidden">
            <button onclick="playCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

<script>
    // [ë³´ì•ˆ ìš°íšŒ] ì—¬ëŸ¬ ê°œì˜ ì„œë²„ ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ í•˜ë‚˜ê°€ ë§‰í˜€ë„ ë‹¤ë¥¸ ê³³ìœ¼ë¡œ ì—°ê²° ì‹œë„
    const gun = Gun([
        'https://gun-manhattan.herokuapp.com/gun',
        'https://gun-us.herokuapp.com/gun',
        'https://gun-eu.herokuapp.com/gun'
    ]);
    
    const IMG_BASE = "https://cdn.jsdelivr.net/gh/hmkim199/java-dalmuti@master/src/dalmuti/img/";
    let room, myName, myId, gameState = {}, selectedCards = [];

    // ì„œë²„ ì—°ê²° ìƒíƒœ í‘œì‹œ
    gun.on('hi', () => document.getElementById('conn-status').innerText = "ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨");
    gun.on('bye', () => document.getElementById('conn-status').innerText = "ğŸ”´ ì—°ê²° ëŠê¹€ (ë°ì´í„° ëª¨ë“œ ê¶Œì¥)");

    function joinGame() {
        const rId = document.getElementById('room-id').value.trim();
        myName = document.getElementById('my-name').value.trim();
        if(!rId || !myName) return alert("ë°© ì´ë¦„ê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        
        myId = 'p_' + Math.random().toString(36).substr(2, 5);
        room = gun.get('dalmuti_ultra_v5_' + rId); // ë²„ì „ì—…ìœ¼ë¡œ ë°ì´í„° ì´ˆê¸°í™”
        
        // ë‚´ ì •ë³´ ë“±ë¡
        room.get('players').get(myId).put({ name: myName, id: myId, lastSeen: Date.now() });
        
        showScreen('lobby-screen');
        
        // í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        room.get('players').map().on((data) => {
            updateLobby();
        });

        // ê²Œì„ ìƒíƒœ ë™ê¸°í™”
        room.get('state').on(s => {
            if(!s) return;
            gameState = JSON.parse(s);
            if(gameState.status === 'playing') { showScreen('game-screen'); renderGame(); }
        });
    }

    function updateLobby() {
        const lobby = document.getElementById('lobby-players');
        lobby.innerHTML = "";
        room.get('players').map().once(p => {
            if(p && p.name) {
                lobby.innerHTML += `<div>ğŸ‘¤ ${p.name}ë‹˜ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤.</div>`;
            }
        });
    }

    function hostStartGame() {
        let pList = [];
        room.get('players').once(data => {
            Object.keys(data).forEach(k => {
                if(data[k] && data[k].name) pList.push({id: data[k].id, name: data[k].name});
            });
            
            if(pList.length < 2) return alert("ìµœì†Œ 2ëª… ì´ìƒ ì ‘ì†í•´ì•¼ í•©ë‹ˆë‹¤.");

            let deck = [];
            for (let i = 1; i <= 12; i++) for (let j = 0; j < i; j++) deck.push(i);
            deck.push(13, 13); deck.sort(() => Math.random() - 0.5);

            let hands = {}; pList.forEach(p => hands[p.id] = []);
            let idx = 0; while(deck.length > 0) hands[pList[idx++ % pList.length].id].push(deck.pop());

            const newState = { 
                status: 'playing', players: pList, hands: hands, turnIdx: 0, 
                lastPlayed: { rank: 14, count: 0, cards: [] }, passCount: 0, finishedIds: [] 
            };
            room.get('state').put(JSON.stringify(newState));
        });
    }

    function renderGame() {
        const turnPlayer = gameState.players[gameState.turnIdx];
        document.getElementById('turn-info').innerText = `ğŸ“¢ [${turnPlayer.name}] ì°¨ë¡€`;
        
        const rb = document.getElementById('rank-board');
        rb.innerHTML = gameState.players.map((p, i) => `<span>[${i+1}ë“±] ${p.name}</span>`).join(' ');

        const tableDiv = document.getElementById('table-cards');
        tableDiv.innerHTML = gameState.lastPlayed.cards.map(r => `
            <div class="card"><div class="card-number">${r==13?'J':r}</div><img src="${IMG_BASE}${r}.png"></div>
        `).join('');

        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        selectedCards = [];
        (gameState.hands[myId] || []).sort((a,b)=>a-b).forEach((rank, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-number">${rank==13?'J':rank}</div><img src="${IMG_BASE}${rank}.png">`;
            card.onclick = () => {
                card.classList.toggle('selected');
                const f = selectedCards.findIndex(c=>c.idx===i);
                if(f>-1) selectedCards.splice(f,1); else selectedCards.push({rank, idx:i});
            };
            handDiv.appendChild(card);
        });
        document.getElementById('controls').classList.toggle('hidden', turnPlayer.id !== myId);
    }

    function playCards() {
        if(selectedCards.length === 0) return;
        const rank = selectedCards[0].rank;
        if(!selectedCards.every(c => c.rank === rank || c.rank === 13)) return alert("ê°™ì€ ì¹´ë“œë§Œ ê°€ëŠ¥!");
        if(gameState.lastPlayed.count === 0 || (selectedCards.length === gameState.lastPlayed.count && rank < gameState.lastPlayed.rank)) {
            gameState.lastPlayed = { rank, count: selectedCards.length, cards: selectedCards.map(c=>c.rank) };
            const toRem = selectedCards.map(c=>c.idx).sort((a,b)=>b-a);
            toRem.forEach(i => gameState.hands[myId].splice(i, 1));
            if(gameState.hands[myId].length === 0) { gameState.finishedIds.push(myId); alert("íƒˆì¶œ!"); }
            gameState.passCount = 0;
            nextTurn();
        } else { alert("ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    }

    function passTurn() {
        gameState.passCount++;
        if(gameState.passCount >= gameState.players.length - gameState.finishedIds.length) {
            gameState.lastPlayed = { rank: 14, count: 0, cards: [] };
            gameState.passCount = 0;
        }
        nextTurn();
    }

    function nextTurn() {
        do { gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length; } 
        while(gameState.finishedIds.includes(gameState.players[gameState.turnIdx].id));
        room.get('state').put(JSON.stringify(gameState));
    }

    function showScreen(id) {
        ['setup-screen', 'lobby-screen', 'game-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
