<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° - ì‹¤ì‹œê°„ ë©€í‹°</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .card { width: 65px; height: 95px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; color: #2c3e50; overflow: hidden; }
        .card-number { font-size: 28px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; background: #ecf0f1; color: #2c3e50; }
        input:focus::placeholder { color: transparent; }
        .hidden { display: none; }
        #conn-status { font-size: 0.7rem; color: #888; margin-bottom: 10px; }
        .player-tag { background: #34495e; padding: 5px 12px; border-radius: 20px; margin: 5px; display: inline-block; font-size: 0.9rem; border: 1px solid #555; }
    </style>
</head>
<body>
    <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
    <div id="conn-status">ì—°ê²° í™•ì¸ ì¤‘...</div>

    <div id="setup-screen" class="screen">
        <p>ê°€ì¡± ëª¨ë‘ ê°™ì€ ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="text" id="room-id" placeholder="ë°© ì´ë¦„ (ì˜ˆ: ë‹¬ë¬´í‹°1)" autocomplete="off">
        <input type="text" id="my-name" placeholder="ë‚´ ì´ë¦„" autocomplete="off">
        <button onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h3>ëŒ€ê¸°ì‹¤</h3>
        <p style="font-size:0.8rem; color:#aaa;">ìƒëŒ€ë°©ì´ ì•ˆ ë³´ì´ë©´ ì™€ì´íŒŒì´ë¥¼ ë„ê³  ì ‘ì†í•´ ë³´ì„¸ìš”.</p>
        <div id="lobby-players" style="margin-bottom:20px; min-height: 50px;"></div>
        <button onclick="hostStartGame()">ëª¨ë‘ ëª¨ì„! ì‹œì‘</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="turn-info" style="color:#3498db; font-weight:bold; margin-bottom:10px;"></div>
        <div id="table-cards" class="card-container" style="background:rgba(255,255,255,0.05); min-height:100px; border-radius:10px;"></div>
        <div id="my-hand" class="card-container"></div>
        <div id="controls" class="hidden">
            <button onclick="playCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun']);
    const IMG_BASE = "https://cdn.jsdelivr.net/gh/hmkim199/java-dalmuti@master/src/dalmuti/img/";
    
    let room, myName, myId, gameState = {}, selectedCards = [];
    let playersInLobby = {}; // ì¤‘ë³µ ë°©ì§€ìš© ì €ì¥ì†Œ

    gun.on('hi', () => document.getElementById('conn-status').innerText = "ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨");
    gun.on('bye', () => document.getElementById('conn-status').innerText = "ğŸŸ¡ ì—°ê²° ë¶ˆì•ˆì • (ë°ì´í„° ëª¨ë“œ ê¶Œì¥)");

    function joinGame() {
        const rId = document.getElementById('room-id').value.trim();
        myName = document.getElementById('my-name').value.trim();
        if(!rId || !myName) return alert("ë°© ì´ë¦„ê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        myId = 'p_' + Math.random().toString(36).substr(2, 5);
        // [ì¤‘ìš”] ë²„ì „ ë²ˆí˜¸ë¥¼ ì˜¬ë ¤ì„œ ì´ì „ ê¼¬ì¸ ë°ì´í„°ë¥¼ í”¼í•©ë‹ˆë‹¤.
        room = gun.get('dalmuti_fix_v2_' + rId);
        
        room.get('players').get(myId).put({ name: myName, id: myId });
        showScreen('lobby-screen');
        
        // ì¤‘ë³µ ì—†ì´ í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        room.get('players').map().on((data, id) => {
            if (data && data.name) {
                playersInLobby[id] = data.name; // IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì´ë¦„ ì €ì¥ (ì¤‘ë³µ ìë™ ì œê±°)
                updateLobbyUI();
            }
        });

        room.get('state').on(s => {
            if(!s) return;
            gameState = JSON.parse(s);
            if(gameState.status === 'playing') { showScreen('game-screen'); renderGame(); }
        });
    }

    function updateLobbyUI() {
        const lobby = document.getElementById('lobby-players');
        lobby.innerHTML = "";
        Object.values(playersInLobby).forEach(name => {
            lobby.innerHTML += `<span class="player-tag">ğŸ‘¤ ${name}</span>`;
        });
    }

    function hostStartGame() {
        const pList = Object.keys(playersInLobby).map(id => ({ id, name: playersInLobby[id] }));
        if(pList.length < 2) return alert("ìµœì†Œ 2ëª… ì´ìƒ ì ‘ì†í•´ì•¼ í•©ë‹ˆë‹¤.");

        let deck = [];
        for (let i = 1; i <= 12; i++) for (let j = 0; j < i; j++) deck.push(i);
        deck.push(13, 13); deck.sort(() => Math.random() - 0.5);

        let hands = {}; pList.forEach(p => hands[p.id] = []);
        let idx = 0; while(deck.length > 0) hands[pList[idx++ % pList.length].id].push(deck.pop());

        room.get('state').put(JSON.stringify({ 
            status: 'playing', players: pList, hands: hands, turnIdx: 0, 
            lastPlayed: { rank: 14, count: 0, cards: [] }, passCount: 0, finishedIds: [] 
        }));
    }

    function renderGame() {
        const turnPlayer = gameState.players[gameState.turnIdx];
        document.getElementById('turn-info').innerText = turnPlayer.id === myId ? "â­ ë‹¹ì‹ ì˜ ì°¨ë¡€!" : `ğŸ“¢ [${turnPlayer.name}] ì°¨ë¡€`;
        const tableDiv = document.getElementById('table-cards');
        tableDiv.innerHTML = gameState.lastPlayed.cards.map(r => `<div class="card"><div class="card-number">${r==13?'J':r}</div><img src="${IMG_BASE}${r}.png"></div>`).join('');
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = "";
        selectedCards = [];
        (gameState.hands[myId] || []).sort((a,b)=>a-b).forEach((rank, i) => {
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<div class="card-number">${rank==13?'J':rank}</div><img src="${IMG_BASE}${rank}.png">`;
            card.onclick = () => { card.classList.toggle('selected'); const f = selectedCards.findIndex(c=>c.idx===i); if(f>-1) selectedCards.splice(f,1); else selectedCards.push({rank, idx:i}); };
            handDiv.appendChild(card);
        });
        document.getElementById('controls').classList.toggle('hidden', turnPlayer.id !== myId);
    }

    function playCards() {
        const rank = selectedCards[0].rank;
        if(gameState.lastPlayed.count === 0 || (selectedCards.length === gameState.lastPlayed.count && rank < gameState.lastPlayed.rank)) {
            gameState.lastPlayed = { rank, count: selectedCards.length, cards: selectedCards.map(c=>c.rank) };
            selectedCards.map(c=>c.idx).sort((a,b)=>b-a).forEach(i => gameState.hands[myId].splice(i, 1));
            if(gameState.hands[myId].length === 0) gameState.finishedIds.push(myId);
            gameState.passCount = 0; nextTurn();
        }
    }

    function passTurn() {
        gameState.passCount++;
        if(gameState.passCount >= gameState.players.length - gameState.finishedIds.length) { gameState.lastPlayed = { rank: 14, count: 0, cards: [] }; gameState.passCount = 0; }
        nextTurn();
    }

    function nextTurn() {
        do { gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length; } while(gameState.finishedIds.includes(gameState.players[gameState.turnIdx].id));
        room.get('state').put(JSON.stringify(gameState));
    }

    function showScreen(id) {
        ['setup-screen', 'lobby-screen', 'game-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
