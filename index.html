<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ì˜¨ë¼ì¸</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; border: 1px solid #34495e; }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .card { width: 65px; height: 95px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; color: #2c3e50; overflow: hidden; }
        .card-number { font-size: 28px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 80%; }
        .btn-sub { background: #34495e; width: auto; font-size: 14px; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 15px; text-align: center; background: #ecf0f1; color: #2c3e50; }
        .hidden { display: none; }
        .player-tag { background: #2c3e50; padding: 8px 15px; border-radius: 20px; margin: 5px; display: inline-block; border: 1px solid var(--accent); font-weight: bold; }
        #invite-area { background: #16a085; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-size: 13px; word-break: break-all; }
    </style>
</head>
<body>
    <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´</h2>

    <div id="setup-screen" class="screen">
        <div id="init-view">
            <button onclick="showCreate()">â• ìƒˆ ë°© ë§Œë“¤ê¸°</button>
            <p style="font-size: 13px; color: #888;">ë˜ëŠ” ì „ë‹¬ë°›ì€ ì´ˆëŒ€ ë§í¬ë¡œ ì ‘ì†í•˜ì„¸ìš”.</p>
        </div>

        <div id="join-view" class="hidden">
            <input type="text" id="my-name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" autocomplete="off">
            <p id="room-id-display" style="color:var(--accent); margin-bottom:10px;"></p>
            <button onclick="joinGame()">ê²Œì„ ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h3>ëŒ€ê¸°ì‹¤</h3>
        <div id="invite-area">
            <p>ğŸ“¢ ì´ˆëŒ€ ë§í¬ (í´ë¦­í•˜ì—¬ ë³µì‚¬)</p>
            <div id="invite-url" style="cursor:pointer; text-decoration:underline; font-weight:bold;" onclick="copyURL()"></div>
        </div>
        <div id="lobby-players" style="margin-bottom:20px; min-height: 50px;"></div>
        <button id="start-btn" onclick="hostStartGame()">ëª¨ë“  í”Œë ˆì´ì–´ ì‹œì‘</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="rank-board" style="font-size:0.85rem; color:var(--accent); margin-bottom:10px;"></div>
        <div id="turn-info" style="color:#3498db; font-weight:bold; margin-bottom:10px;"></div>
        <div id="table-cards" class="card-container" style="background:rgba(255,255,255,0.05); min-height:110px; border-radius:10px;"></div>
        <div id="my-hand" class="card-container"></div>
        <div id="controls" class="hidden">
            <button onclick="playCards()" style="width:45%">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d; width:45%">í†µê³¼</button>
        </div>
    </div>

<script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const IMG_BASE = "https://cdn.jsdelivr.net/gh/hmkim199/java-dalmuti@master/src/dalmuti/img/";
    
    let room, myName, myId, gameState = {}, selectedCards = [];
    let playersMap = new Map();
    let currentRoomId = new URLSearchParams(window.location.search).get('room');

    // ê¸°ê¸° ê³ ìœ  ID ìƒì„±/ë³µêµ¬
    if(!localStorage.getItem('dm_uid_v2')) localStorage.setItem('dm_uid_v2', 'u' + Math.random().toString(36).substr(2, 5));
    myId = localStorage.getItem('dm_uid_v2');

    // ë§í¬ë¡œ ë“¤ì–´ì˜¨ ê²½ìš° ë°”ë¡œ ì´ë¦„ ì…ë ¥ì°½ í‘œì‹œ
    if(currentRoomId) {
        document.getElementById('init-view').classList.add('hidden');
        document.getElementById('join-view').classList.remove('hidden');
        document.getElementById('room-id-display').innerText = "ì ‘ì† ì½”ë“œ: " + currentRoomId;
    }

    function showCreate() {
        currentRoomId = 'room-' + Math.random().toString(36).substr(2, 6);
        document.getElementById('init-view').classList.add('hidden');
        document.getElementById('join-view').classList.remove('hidden');
        document.getElementById('room-id-display').innerText = "ìƒˆ ë°©ì„ ê°œì„¤í•©ë‹ˆë‹¤.";
    }

    function joinGame() {
        myName = document.getElementById('my-name').value.trim();
        if(!myName) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        
        const inviteURL = window.location.origin + window.location.pathname + "?room=" + currentRoomId;
        document.getElementById('invite-url').innerText = inviteURL;

        room = gun.get('dalmuti_invite_v1_' + currentRoomId);
        room.get('players').get(myId).put({ name: myName, id: myId });
        
        showScreen('lobby-screen');

        room.get('players').map().on((data, id) => {
            if (data && data.name) {
                playersMap.set(id, data.name);
                updateLobbyUI();
            }
        });

        room.get('state').on(s => {
            if(!s) return;
            gameState = JSON.parse(s);
            if(gameState.status === 'playing') { showScreen('game-screen'); renderGame(); }
        });
    }

    function updateLobbyUI() {
        const lobby = document.getElementById('lobby-players');
        lobby.innerHTML = "";
        playersMap.forEach(name => lobby.innerHTML += `<span class="player-tag">ğŸ‘¤ ${name}</span>`);
    }

    function copyURL() {
        const url = document.getElementById('invite-url').innerText;
        navigator.clipboard.writeText(url).then(() => alert("ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´í†¡ìœ¼ë¡œ ê³µìœ í•˜ì„¸ìš”."));
    }

    function hostStartGame() {
        const pList = [];
        playersMap.forEach((name, id) => pList.push({ id, name }));
        if(pList.length < 2) return alert("2ëª… ì´ìƒ ëª¨ì—¬ì•¼ í•©ë‹ˆë‹¤.");

        let deck = [];
        for (let i = 1; i <= 12; i++) for (let j = 0; j < i; j++) deck.push(i);
        deck.push(13, 13); deck.sort(() => Math.random() - 0.5);

        let hands = {}; pList.forEach(p => hands[p.id] = []);
        let idx = 0; while(deck.length > 0) hands[pList[idx++ % pList.length].id].push(deck.pop());

        room.get('state').put(JSON.stringify({ 
            status: 'playing', players: pList, hands: hands, turnIdx: 0, 
            lastPlayed: { rank: 14, count: 0, cards: [] }, passCount: 0, finishedIds: [] 
        }));
    }

    function renderGame() {
        const turnPlayer = gameState.players[gameState.turnIdx];
        document.getElementById('turn-info').innerText = turnPlayer.id === myId ? "â­ ë‹¹ì‹ ì˜ ì°¨ë¡€!" : `ğŸ“¢ [${turnPlayer.name}] ì°¨ë¡€`;
        document.getElementById('rank-board').innerHTML = "ìˆœì„œ: " + gameState.players.map(p => p.name).join(' â” ');
        document.getElementById('table-cards').innerHTML = gameState.lastPlayed.cards.map(r => `<div class="card"><div class="card-number">${r==13?'J':r}</div><img src="${IMG_BASE}${r}.png"></div>`).join('');
        const handDiv = document.getElementById('my-hand');
        handDiv.innerHTML = ""; selectedCards = [];
        (gameState.hands[myId] || []).sort((a,b)=>a-b).forEach((rank, i) => {
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<div class="card-number">${rank==13?'J':rank}</div><img src="${IMG_BASE}${rank}.png">`;
            card.onclick = () => { card.classList.toggle('selected'); const f = selectedCards.findIndex(c=>c.idx===i); if(f>-1) selectedCards.splice(f,1); else selectedCards.push({rank, idx:i}); };
            handDiv.appendChild(card);
        });
        document.getElementById('controls').classList.toggle('hidden', turnPlayer.id !== myId);
    }

    function playCards() {
        if(selectedCards.length === 0) return;
        const rank = selectedCards[0].rank;
        if(gameState.lastPlayed.count === 0 || (selectedCards.length === gameState.lastPlayed.count && rank < gameState.lastPlayed.rank)) {
            gameState.lastPlayed = { rank, count: selectedCards.length, cards: selectedCards.map(c=>c.rank) };
            selectedCards.map(c=>c.idx).sort((a,b)=>b-a).forEach(i => gameState.hands[myId].splice(i, 1));
            if(gameState.hands[myId].length === 0) gameState.finishedIds.push(myId);
            gameState.passCount = 0; nextTurn();
        }
    }

    function passTurn() {
        gameState.passCount++;
        if(gameState.passCount >= gameState.players.length - gameState.finishedIds.length) {
            gameState.lastPlayed = { rank: 14, count: 0, cards: [] }; gameState.passCount = 0;
        }
        nextTurn();
    }

    function nextTurn() {
        do { gameState.turnIdx = (gameState.turnIdx + 1) % gameState.players.length; } 
        while(gameState.finishedIds.includes(gameState.players[gameState.turnIdx].id));
        room.get('state').put(JSON.stringify(gameState));
    }

    function showScreen(id) {
        ['setup-screen', 'lobby-screen', 'game-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
