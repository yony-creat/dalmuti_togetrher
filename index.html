<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; --dalmuti-color: #f1c40f; --peon-color: #95a5a6; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        #setup, #role-draw, #tax-phase, #game-board, #round-result-screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #rank-board { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--accent); }
        .rank-badge { display: inline-block; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }
        .badge-dalmuti { background: var(--accent); color: #000; }
        .badge-peon { background: #7f8c8d; color: #fff; }
        .badge-common { background: #34495e; color: #fff; }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .card { width: 70px; height: 105px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; color: #2c3e50; }
        .card-number { font-size: 32px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; }
        .table-area { min-height: 130px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 15px 0; padding: 10px; border: 1px dashed #555; }
        .hidden { display: none; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; background: #ecf0f1; color: #2c3e50; }
        .finished { opacity: 0.5; text-decoration: line-through; }
        .role-item { margin: 10px 0; font-size: 1.1rem; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); }
        #status-bar { padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; background: #c0392b; font-weight: bold; }
        .online { background: #27ae60 !important; }
    </style>
</head>
<body>
    <div id="status-bar">ğŸ“¡ ì‹ í˜¸ê¸° ì¤€ë¹„ ì¤‘...</div>

    <div id="setup">
        <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
        
        <div id="host-setup">
            <p>ë‚´ ì´ë¦„ì„ ì…ë ¥í•˜ê³  ë°©ì„ ë§Œë“œì„¸ìš”.</p>
            <input type="text" id="host-name-input" placeholder="ë°©ì¥ ì´ë¦„">
            <button onclick="initHost()">ë°© ë§Œë“¤ê¸°</button>
            <div id="invite-section" class="hidden" style="margin-top:20px;">
                <p style="font-size:12px; color:var(--accent);">íŒ€ì›ë“¤ì—ê²Œ ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”!</p>
                <button onclick="copyInviteLink()" style="background:#2980b9; font-size:13px; width:100%;">ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬í•˜ê¸°</button>
                <div id="joined-players" style="margin-top:15px; font-size:14px;">ì°¸ê°€ì ëŒ€ê¸° ì¤‘...</div>
                <button onclick="startRoleDrawing()" style="margin-top:15px; background:#27ae60;">ì „ì› ì…ì¥! ì„œì—´ ì •í•˜ê¸° ì‹œì‘</button>
            </div>
        </div>

        <div id="guest-setup" class="hidden">
            <p>ì‚¬ìš©í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="guest-name-input" placeholder="ì°¸ê°€ì ì´ë¦„">
            <button onclick="initGuest()">ì°¸ê°€í•˜ê¸°</button>
            <div id="wait-msg" class="hidden" style="margin-top:20px; color:var(--accent);">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
        </div>
    </div>

    <div id="role-draw" class="hidden">
        <h3>ğŸƒ ì²« ì„œì—´ ì •í•˜ê¸°</h3>
        <p>ì¹´ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”! ëª¨ë‘ê°€ ë½‘ì•„ì•¼ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤.</p>
        <div id="role-cards" class="card-container"></div>
        <div id="role-results" style="margin-top:20px;"></div>
        <button id="tax-start-btn" class="hidden" onclick="prepareTaxPhase()">ì„¸ê¸ˆ ë‚©ë¶€ ë‹¨ê³„ë¡œ</button>
    </div>

    <div id="tax-phase" class="hidden">
        <h3>ğŸ’° ì„¸ê¸ˆ ë‚©ë¶€ ë° í•˜ì‚¬</h3>
        <div id="tax-instruction" style="margin-bottom:15px; color:var(--accent);"></div>
        <div id="tax-hand" class="card-container"></div>
        <button id="tax-submit-btn" onclick="handleTaxSubmit()">ì¹´ë“œ í™•ì •</button>
    </div>

    <div id="game-board" class="hidden">
        <div id="rank-board"></div>
        <div id="turn-indicator" style="font-size:1.2rem; color:#3498db; font-weight:bold; margin-bottom:10px;">ì°¨ë¡€</div>
        <div id="other-players-status" style="font-size:0.8rem; margin-bottom:10px; color:#aaa;"></div>
        <div class="table-area"><div id="last-played-cards" class="card-container"></div></div>
        <button id="show-btn" onclick="revealHand()">ë‚´ ì¹´ë“œ í™•ì¸í•˜ê¸°</button>
        <div id="player-hand" class="card-container hidden"></div>
        <div id="actions" class="hidden" style="margin-top:20px;">
            <button onclick="playSelectedCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

    <div id="round-result-screen" class="hidden">
        <h3>ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ! ìƒˆë¡œìš´ ì„œì—´</h3>
        <div id="final-ranking-list"></div>
        <div style="margin-top:30px;">
            <button onclick="prepareTaxPhase()" style="background:#2ecc71;">ë‹¤ìŒ ë¼ìš´ë“œ (ì„¸ê¸ˆ ë‹¨ê³„)</button>
            <button onclick="location.reload()" style="background:#e74c3c;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

<script>
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    let peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });
    let players = [], currentPlayerIndex = 0, lastPlayed = { rank: 14, count: 0 }, selectedCards = [], myId, connMap = {};
    let myRole, myHand = [], rankDrawingDeck = [], taxStorage = [], finishOrder = [];

    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room');

    peer.on('open', id => {
        myId = id;
        document.getElementById('status-bar').innerText = "ğŸŸ¢ ì‹ í˜¸ ì¤€ë¹„ ì™„ë£Œ";
        document.getElementById('status-bar').classList.add('online');
        if(roomCode) {
            document.getElementById('host-setup').classList.add('hidden');
            document.getElementById('guest-setup').classList.remove('hidden');
        }
    });

    // --- ì ‘ì† ë¡œì§ ---
    function initHost() {
        const name = document.getElementById('host-name-input').value.trim();
        if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        players.push({ id: myId, name, hand: [], isFinished: false, roleTitle: "", rankVal: 0 });
        document.getElementById('host-name-input').classList.add('hidden');
        document.querySelector('#host-setup button').classList.add('hidden');
        document.getElementById('invite-section').classList.remove('hidden');
        updateJoinedList();
        peer.on('connection', conn => {
            conn.on('open', () => {
                conn.on('data', data => handleData(data, conn));
            });
        });
    }

    function initGuest() {
        const name = document.getElementById('guest-name-input').value.trim();
        if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        const conn = peer.connect(roomCode);
        conn.on('open', () => {
            connMap[roomCode] = conn;
            conn.send({ type: 'JOIN', name });
            document.getElementById('guest-name-input').disabled = true;
            document.querySelector('#guest-setup button').classList.add('hidden');
            document.getElementById('wait-msg').classList.remove('hidden');
            conn.on('data', data => handleData(data, conn));
        });
    }

    function handleData(data, conn) {
        if(data.type === 'JOIN') {
            connMap[conn.peer] = conn;
            players.push({ id: conn.peer, name: data.name, hand: [], isFinished: false, roleTitle: "", rankVal: 0 });
            updateJoinedList();
            syncAll();
        }
        if(data.type === 'SYNC') {
            players = data.players;
            currentPlayerIndex = data.currentPlayerIndex;
            lastPlayed = data.lastPlayed;
            if(data.screen) showScreen(data.screen);
            if(data.screen === 'role-draw') renderRoleDrawing();
            if(data.screen === 'tax-phase') setupTaxUI();
            if(data.screen === 'game-board') renderGameBoard();
            if(data.screen === 'round-result-screen') renderResult();
        }
        if(data.type === 'DRAW_RES') {
            const p = players.find(x => x.id === data.uid);
            p.rankVal = data.rank;
            checkAllDrawn();
        }
        if(data.type === 'TAX_SUBMIT') {
            taxStorage = [...taxStorage, ...data.cards];
            // ì‹¤ì œ í•˜ì‚¬ ë¡œì§ì€ ë°©ì¥ì´ ì œì–´
        }
    }

    // --- ê²Œì„ ë¡œì§ (ì‚¬ìš©ì ì›ë³¸ ê¸°ë°˜) ---
    function startRoleDrawing() {
        if(players.length < 2) return alert("ìµœì†Œ 2ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.");
        rankDrawingDeck = Array.from({length: 12}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        syncAll('role-draw');
    }

    function renderRoleDrawing() {
        const container = document.getElementById('role-cards');
        container.innerHTML = '';
        players.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            if(p.rankVal > 0) {
                card.innerHTML = `<div class="card-number">${p.rankVal}</div><img src="${IMG_BASE}${p.rankVal}.png">`;
            } else {
                card.innerHTML = `<div class="card-number">?</div>`;
                if(p.id === myId) card.onclick = () => {
                    const r = rankDrawingDeck.pop() || Math.floor(Math.random()*12)+1;
                    if(roomCode) connMap[roomCode].send({type: 'DRAW_RES', rank: r, uid: myId});
                    else { players[0].rankVal = r; checkAllDrawn(); }
                };
            }
            container.appendChild(card);
        });
    }

    function checkAllDrawn() {
        if(players.every(p => p.rankVal > 0)) {
            players.sort((a, b) => a.rankVal - b.rankVal);
            players.forEach((p, i) => {
                p.roleTitle = i === 0 ? "ğŸ‘‘ ìœ„ëŒ€í•œ ë‹¬ë¬´í‹°" : (i === players.length-1 ? "ğŸ’© ë†ë…¸" : `${i+1}ë“± í‰ë¯¼`);
            });
            document.getElementById('role-results').innerHTML = players.map(p => `<div>${p.roleTitle}: ${p.name}</div>`).join('');
            document.getElementById('tax-start-btn').classList.remove('hidden');
            syncAll('role-draw');
        }
    }

    function prepareTaxPhase() {
        let deck = [];
        for (let i = 1; i <= 12; i++) for (let j = 0; j < i; j++) deck.push(i);
        deck.push(13, 13); deck.sort(() => Math.random() - 0.5);
        players.forEach(p => p.hand = []);
        let i = 0; while (deck.length > 0) players[i++ % players.length].hand.push(deck.pop());
        syncAll('tax-phase');
    }

    function setupTaxUI() {
        const me = players.find(p => p.id === myId);
        myHand = [...me.hand].sort((a,b)=>a-b);
        document.getElementById('tax-instruction').innerText = `${me.name}(${me.roleTitle})ë‹˜, ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.`;
        const container = document.getElementById('tax-hand');
        container.innerHTML = '';
        selectedCards = [];
        myHand.forEach((rank, idx) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-number">${rank===13?'J':rank}</div><img src="${IMG_BASE}${rank}.png">`;
            card.onclick = () => {
                card.classList.toggle('selected');
                const fIdx = selectedCards.findIndex(c => c.idx === idx);
                if(fIdx > -1) selectedCards.splice(fIdx, 1); else selectedCards.push({rank, idx});
            };
            container.appendChild(card);
        });
    }

    function renderGameBoard() {
        const me = players.find(p => p.id === myId);
        myHand = [...me.hand].sort((a,b)=>a-b);
        const p = players[currentPlayerIndex];
        document.getElementById('turn-indicator').innerText = `ğŸ“¢ [${p.name}] ì°¨ë¡€ (${p.roleTitle})`;
        document.getElementById('rank-board').innerHTML = players.map(x => `<span class="rank-badge ${x.id===players[0].id?'badge-dalmuti':(x.id===players[players.length-1].id?'badge-peon':'badge-common')}">${x.name} (${x.hand.length})</span>`).join(' ');
        
        const table = document.getElementById('last-played-cards');
        table.innerHTML = '';
        if(lastPlayed.count > 0) {
            for(let i=0; i<lastPlayed.count; i++) {
                table.innerHTML += `<div class="card"><div class="card-number">${lastPlayed.rank===13?'J':lastPlayed.rank}</div><img src="${IMG_BASE}${lastPlayed.rank}.png"></div>`;
            }
        }
    }

    function revealHand() {
        const div = document.getElementById('player-hand');
        div.innerHTML = ''; div.classList.remove('hidden');
        document.getElementById('actions').classList.remove('hidden');
        myHand.forEach((rank, idx) => {
            const c = document.createElement('div');
            c.className = 'card';
            c.innerHTML = `<div class="card-number">${rank===13?'J':rank}</div><img src="${IMG_BASE}${rank}.png">`;
            c.onclick = () => {
                c.classList.toggle('selected');
                const fIdx = selectedCards.findIndex(x => x.idx === idx);
                if(fIdx > -1) selectedCards.splice(fIdx, 1); else selectedCards.push({rank, idx});
            };
            div.appendChild(c);
        });
    }

    function playSelectedCards() {
        if(players[currentPlayerIndex].id !== myId) return alert("ë‹¹ì‹  ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤.");
        const rank = selectedCards[0].rank;
        if (lastPlayed.count === 0 || (selectedCards.length === lastPlayed.count && rank < lastPlayed.rank)) {
            lastPlayed = { rank, count: selectedCards.length };
            const me = players.find(x => x.id === myId);
            selectedCards.sort((a,b)=>b.idx-a.idx).forEach(c => me.hand.splice(c.idx, 1));
            if(me.hand.length === 0) me.isFinished = true;
            nextTurn();
        }
    }

    function nextTurn() {
        do { currentPlayerIndex = (currentPlayerIndex + 1) % players.length; } while (players[currentPlayerIndex].isFinished);
        syncAll('game-board');
    }

    function passTurn() { nextTurn(); }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function syncAll(screen) {
        if(myRole !== 'host') return;
        const data = { type: 'SYNC', players, currentPlayerIndex, lastPlayed, screen };
        Object.values(connMap).forEach(c => c.send(data));
        handleData(data);
    }

    function updateJoinedList() {
        document.getElementById('joined-players').innerHTML = "<b>ì°¸ê°€ì:</b> " + players.map(p => p.name).join(', ');
    }

    function copyInviteLink() {
        const link = window.location.origin + window.location.pathname + "?room=" + myId;
        navigator.clipboard.writeText(link).then(() => alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! íŒ€ì›ë“¤ì—ê²Œ ë³´ë‚´ì„¸ìš”."));
    }

    function showScreen(id) {
        ['setup', 'role-draw', 'tax-phase', 'game-board', 'round-result-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
