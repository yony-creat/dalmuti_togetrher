<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; --dalmuti-color: #f1c40f; --peon-color: #95a5a6; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        #setup, #lobby, #role-draw, #tax-phase, #game-board, #round-result-screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #34495e; }
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; min-height: 110px; }
        .card { width: 70px; height: 105px; background: white; border-radius: 8px; border: 2px solid #333; cursor: pointer; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; color: #2c3e50; }
        .card-number { font-size: 32px; font-weight: bold; position: absolute; z-index: 1; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
        .card.selected { transform: translateY(-15px); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; background: #ecf0f1; color: #2c3e50; }
        .hidden { display: none; }
        #status-bar { padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; background: #c0392b; font-weight: bold; }
        .online { background: #27ae60 !important; }
        .rank-badge { display: inline-block; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; border: 1px solid var(--accent); }
    </style>
</head>
<body>
    <div id="status-bar">ğŸ“¡ ì‹ í˜¸ ëŒ€ê¸° ì¤‘...</div>

    <div id="setup">
        <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
        <input type="text" id="my-name-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <div id="host-init-btn"><button onclick="beHost()">ğŸ° ë°© ë§Œë“¤ê¸° (ë‚´ê°€ ë°©ì¥)</button></div>
        <div id="guest-init-btn" class="hidden"><button onclick="beGuest()">ì…ì¥í•˜ê¸°</button></div>
    </div>

    <div id="lobby" class="hidden">
        <p style="font-size:12px; color:var(--accent);">ğŸ”— ì•„ë˜ ë§í¬ë¥¼ <b>íŒ€ì›ë“¤ì—ê²Œ</b> ê³µìœ í•˜ì„¸ìš”!</p>
        <button onclick="copyInviteLink()" style="background:#2980b9; font-size:13px; margin-bottom:15px;">ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬í•˜ê¸°</button>
        <div id="player-list" style="margin-bottom:20px;">ì°¸ê°€ì ëŒ€ê¸° ì¤‘...</div>
        <button id="start-draw-btn" class="hidden" onclick="hostStartDraw()" style="background:#27ae60;">ì „ì› ì…ì¥! ì„œì—´ ì •í•˜ê¸° ì‹œì‘</button>
        <p id="guest-wait-msg" class="hidden" style="color:#aaa;">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>

    <div id="role-draw" class="hidden">
        <h3>ğŸƒ ì²« ì„œì—´ ì •í•˜ê¸°</h3>
        <p>ì¹´ë“œë¥¼ í•œ ì¥ ê³¨ë¼ì£¼ì„¸ìš”! ëª¨ë‘ê°€ ë½‘ìœ¼ë©´ ì„œì—´ì´ ê²°ì •ë©ë‹ˆë‹¤.</p>
        <div id="role-cards" class="card-container"></div>
        <div id="role-results" style="margin-top:20px; font-weight:bold;"></div>
        <button id="tax-start-btn" class="hidden" onclick="hostStartTax()" style="background:#2ecc71;">ğŸ’° ì„¸ê¸ˆ ë‚©ë¶€ ë‹¨ê³„ë¡œ</button>
    </div>

    <div id="tax-phase" class="hidden">
        <h3>ğŸ’° ì„¸ê¸ˆ ë‚©ë¶€ ë° í•˜ì‚¬</h3>
        <div id="tax-msg" style="color:var(--accent); font-weight:bold; margin-bottom:10px;"></div>
        <div id="tax-hand" class="card-container"></div>
        <button id="tax-submit-btn" onclick="submitTax()">ì¹´ë“œ í™•ì •</button>
    </div>

    <div id="game-board" class="hidden">
        <div id="rank-display" style="margin-bottom:10px;"></div>
        <div id="turn-indicator" style="font-size:1.1rem; color:var(--accent); font-weight:bold; margin-bottom:10px;"></div>
        <div class="table-area" style="min-height:120px; background:rgba(255,255,255,0.05); border-radius:10px; padding:10px;"><div id="table" class="card-container"></div></div>
        <button id="show-btn" onclick="revealHand()">ë‚´ ì¹´ë“œ í™•ì¸í•˜ê¸°</button>
        <div id="hand" class="card-container hidden"></div>
        <div id="actions" class="hidden" style="margin-top:20px;">
            <button onclick="playCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

    <div id="round-result-screen" class="hidden">
        <h3>ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ! ìƒˆë¡œìš´ ì„œì—´</h3>
        <div id="final-ranking-list"></div>
        <div style="margin-top:30px;">
            <button id="continue-btn" class="hidden" onclick="hostStartTax()" style="background:#2ecc71;">ì´ ê²°ê³¼ë¡œ ê³„ì† ì§„í–‰</button>
            <button onclick="location.reload()" style="background:#e74c3c;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

<script>
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    let peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });
    let connMap = {}, myRole, myHand = [], selected = [], myId, hostId;
    let gameState = { players: [], status: 'setup', turn: 0, lastMove: {rank:14, count:0}, taxStorage: [], finishOrder: [] };
    const roomParam = new URLSearchParams(window.location.search).get('room');

    peer.on('open', id => {
        myId = id; document.getElementById('status-bar').innerText = "ğŸŸ¢ ì‹ í˜¸ ì¤€ë¹„ ì™„ë£Œ";
        document.getElementById('status-bar').classList.add('online');
        if(roomParam) { hostId = roomParam; document.getElementById('host-init-btn').classList.add('hidden'); document.getElementById('guest-init-btn').classList.remove('hidden'); }
    });

    function beHost() {
        myRole = 'host'; hostId = myId; const name = document.getElementById('my-name-input').value || "ë°©ì¥";
        gameState.players.push({id: myId, name, rankVal: 0, role: 'ì‹¬ì‚¬ì¤‘', isFinished: false, cardsLeft: 0});
        gameState.status = 'lobby'; showScreen('lobby'); updatePlayerList();
        peer.on('connection', c => { c.on('open', () => { c.on('data', d => handleData(d, c)); }); });
    }

    function beGuest() {
        myRole = 'guest'; const name = document.getElementById('my-name-input').value || "ì°¸ê°€ì";
        const conn = peer.connect(hostId);
        conn.on('open', () => {
            connMap[hostId] = conn; conn.send({type: 'JOIN', name});
            showScreen('lobby'); document.getElementById('guest-wait-msg').classList.remove('hidden');
            conn.on('data', d => handleData(d, conn));
        });
    }

    function handleData(data, conn) {
        if(data.type === 'JOIN') {
            connMap[conn.peer] = conn;
            gameState.players.push({id: conn.peer, name: data.name, rankVal: 0, role: 'ì‹¬ì‚¬ì¤‘', isFinished: false, cardsLeft: 0});
            broadcastSync(); updatePlayerList();
            if(gameState.players.length >= 2) document.getElementById('start-draw-btn').classList.remove('hidden');
        }
        if(data.type === 'SYNC') {
            gameState = data.state; if(data.hand) myHand = data.hand;
            refreshUI();
        }
        if(data.type === 'PICK_RES') {
            const p = gameState.players.find(x => x.id === data.uid);
            if(p) { p.rankVal = data.val; checkAllPicks(); }
        }
        if(data.type === 'TAX_RES') {
            gameState.taxStorage.push({from: data.uid, cards: data.cards});
            checkTaxDone();
        }
        if(data.type === 'FINISH') {
            const p = gameState.players.find(x => x.id === data.uid);
            p.isFinished = true; if(!gameState.finishOrder.includes(data.uid)) gameState.finishOrder.push(data.uid);
            checkRoundEnd();
        }
    }

    function hostStartDraw() { gameState.status = 'role-draw'; broadcastSync(); refreshUI(); }

    function refreshUI() {
        showScreen(gameState.status);
        if(gameState.status === 'role-draw') renderRoleCards();
        if(gameState.status === 'tax-phase') renderTaxUI();
        if(gameState.status === 'game-board') renderGameBoard();
        if(gameState.status === 'round-result-screen') renderResult();
    }

    function renderRoleCards() {
        const div = document.getElementById('role-cards'); div.innerHTML = "";
        gameState.players.forEach(p => {
            const c = document.createElement('div'); c.className = 'card';
            if(p.rankVal > 0) c.innerHTML = `<div class="card-number">${p.rankVal}</div><img src="${IMG_BASE}${p.rankVal}.png">`;
            else {
                c.innerHTML = `<div class="card-number">?</div>`;
                if(p.id === myId) c.onclick = () => {
                    const val = Math.floor(Math.random() * 12) + 1;
                    if(myRole === 'host') { gameState.players.find(x => x.id === myId).rankVal = val; checkAllPicks(); }
                    else connMap[hostId].send({type: 'PICK_RES', val, uid: myId});
                };
            }
            div.appendChild(c);
        });
    }

    function checkAllPicks() {
        if(gameState.players.every(p => p.rankVal > 0)) {
            gameState.players.sort((a,b) => a.rankVal - b.rankVal);
            gameState.players.forEach((p, i) => p.role = i===0 ? "ğŸ‘‘ ë‹¬ë¬´í‹°" : (i===gameState.players.length-1 ? "ğŸ’© ë†ë…¸" : `${i+1}ë“± í‰ë¯¼`));
            document.getElementById('role-results').innerHTML = gameState.players.map(p => `<div>${p.role}: ${p.name}</div>`).join('');
            if(myRole === 'host') { document.getElementById('tax-start-btn').classList.remove('hidden'); broadcastSync(); }
        }
    }

    function hostStartTax() {
        let deck = []; for(let i=1; i<=12; i++) for(let j=0; j<i; j++) deck.push(i);
        deck.push(13, 13); deck.sort(() => Math.random() - 0.5);
        gameState.status = 'tax-phase'; gameState.taxStorage = [];
        gameState.players.forEach((p, i) => {
            let h = []; for(let j=i; j<deck.length; j+=gameState.players.length) h.push(deck[j]);
            if(p.id === myId) myHand = h;
            else connMap[p.id].send({type: 'SYNC', state: gameState, hand: h});
        });
        broadcastSync(); refreshUI();
    }

    function renderTaxUI() {
        const me = gameState.players.find(p => p.id === myId);
        const dal = gameState.players[0]; const peon = gameState.players[gameState.players.length-1];
        document.getElementById('tax-msg').innerText = (me.id === peon.id) ? "ğŸ’© ë†ë…¸ë‹˜, ë‹¬ë¬´í‹°ì—ê²Œ ê°€ì¥ ì¢‹ì€ ì¹´ë“œ 2ì¥ì„ ë°”ì¹˜ì„¸ìš”." : (me.id === dal.id) ? "ğŸ‘‘ ë‹¬ë¬´í‹°ë‹˜, ë†ë…¸ì—ê²Œ ì¤„ ì•„ë¬´ ì¹´ë“œ 2ì¥ì„ ê³ ë¥´ì„¸ìš”." : "ì„¸ê¸ˆ ë‚©ë¶€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
        const div = document.getElementById('tax-hand'); div.innerHTML = "";
        if(me.id === peon.id || me.id === dal.id) {
            myHand.sort((a,b)=>a-b).forEach((r, i) => {
                const c = document.createElement('div'); c.className = 'card';
                c.innerHTML = `<div class="card-number">${r}</div><img src="${IMG_BASE}${r}.png">`;
                c.onclick = () => { c.classList.toggle('selected'); const idx = selected.findIndex(x=>x.i===i); if(idx>-1) selected.splice(idx,1); else selected.push({r, i}); };
                div.appendChild(c);
            });
        }
    }

    function submitTax() {
        if(selected.length !== 2) return alert("2ì¥ì„ ê³¨ë¼ì•¼ í•©ë‹ˆë‹¤.");
        const cards = selected.map(s => s.r);
        selected.sort((a,b)=>b.i-a.i).forEach(s => myHand.splice(s.i, 1));
        if(myRole === 'host') { gameState.taxStorage.push({from: myId, cards}); checkTaxDone(); }
        else connMap[hostId].send({type: 'TAX_RES', uid: myId, cards});
        document.getElementById('tax-phase').innerHTML = "<h3>ì „ì†¡ ì™„ë£Œ! ëŒ€ê¸° ì¤‘...</h3>";
    }

    function checkTaxDone() {
        if(gameState.taxStorage.length === 2) {
            const dal = gameState.players[0]; const peon = gameState.players[gameState.players.length-1];
            const pToD = gameState.taxStorage.find(x => x.from === peon.id).cards;
            const dToP = gameState.taxStorage.find(x => x.from === dal.id).cards;
            gameState.status = 'game-board';
            gameState.players.forEach(p => {
                let h = (p.id === myId) ? myHand : [];
                if(p.id === dal.id) h = h.concat(pToD); else if(p.id === peon.id) h = h.concat(dToP);
                if(p.id === myId) myHand = h; else connMap[p.id].send({type: 'SYNC', state: gameState, hand: h});
            });
            broadcastSync(); refreshUI();
        }
    }

    function renderGameBoard() {
        const turnP = gameState.players[gameState.turn];
        document.getElementById('turn-indicator').innerText = turnP.id === myId ? "â­ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤!" : `ğŸ“¢ [${turnP.name}] ì°¨ë¡€`;
        document.getElementById('rank-display').innerHTML = gameState.players.map(p => `<span class="rank-badge" style="${p.id===turnP.id?'background:var(--accent);color:#000':''}">${p.name}(ğŸ´${p.cardsLeft || 0})</span>`).join(' ');
        const table = document.getElementById('table'); table.innerHTML = "";
        for(let i=0; i<gameState.lastMove.count; i++) table.innerHTML += `<div class="card"><div class="card-number">${gameState.lastMove.rank}</div><img src="${IMG_BASE}${gameState.lastMove.rank}.png"></div>`;
    }

    function revealHand() {
        const div = document.getElementById('hand'); div.innerHTML = ""; div.classList.remove('hidden'); document.getElementById('actions').classList.remove('hidden');
        myHand.sort((a,b)=>a-b).forEach((r, i) => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<div class="card-number">${r}</div><img src="${IMG_BASE}${r}.png">`;
            c.onclick = () => { c.classList.toggle('selected'); const idx = selected.findIndex(x=>x.i===i); if(idx>-1) selected.splice(idx,1); else selected.push({r, i}); };
            div.appendChild(c);
        });
    }

    function playCards() {
        if(gameState.players[gameState.turn].id !== myId) return alert("ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤.");
        const r = selected[0].r;
        if(gameState.lastMove.count === 0 || (selected.length === gameState.lastMove.count && r < gameState.lastMove.rank)) {
            gameState.lastMove = {rank: r, count: selected.length};
            selected.sort((a,b)=>b.i-a.i).forEach(s => myHand.splice(s.i, 1));
            const me = gameState.players.find(p => p.id === myId); me.cardsLeft = myHand.length;
            if(myHand.length === 0) { me.isFinished = true; if(myRole==='host') { gameState.finishOrder.push(myId); checkRoundEnd(); } else connMap[hostId].send({type:'FINISH', uid:myId}); }
            nextTurn();
        }
    }

    function nextTurn() {
        do { gameState.turn = (gameState.turn + 1) % gameState.players.length; } while(gameState.players[gameState.turn].isFinished);
        broadcastSync(); refreshUI();
    }

    function passTurn() { nextTurn(); }

    function checkRoundEnd() {
        const active = gameState.players.filter(p => !p.isFinished);
        if(active.length <= 1) {
            if(active.length === 1) gameState.finishOrder.push(active[0].id);
            let nP = []; gameState.finishOrder.forEach(id => nP.push(gameState.players.find(x => x.id === id)));
            gameState.players = nP; assignRoles(); gameState.status = 'round-result-screen'; broadcastSync(); refreshUI();
        }
    }

    function broadcastSync() { if(myRole === 'host') Object.values(connMap).forEach(c => c.send({type: 'SYNC', state: gameState})); }
    function copyInviteLink() { const link = window.location.origin + window.location.pathname + "?room=" + myId; navigator.clipboard.writeText(link).then(() => alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!")); }
    function showScreen(id) { ['setup', 'lobby', 'role-draw', 'tax-phase', 'game-board', 'round-result-screen'].forEach(s => document.getElementById(s).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
</script>
</body>
</html>
