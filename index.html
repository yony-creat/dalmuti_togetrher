<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; --dalmuti-color: #f1c40f; --peon-color: #95a5a6; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        
        /* ìƒë‹¨ ì •ë³´ ê³ ì • */
        #status-bar { padding: 10px; margin-bottom: 5px; border-radius: 8px; font-size: 14px; background: #c0392b; font-weight: bold; }
        #role-header { background: #2c3e50; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-bottom: 3px solid var(--accent); font-size: 1rem; }
        .online { background: #27ae60 !important; }

        /* í™”ë©´ ì»¨í…Œì´ë„ˆ */
        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #34495e; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ (ìˆ«ì ì „ìš©) */
        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; min-height: 110px; }
        .card { 
            width: 70px; height: 105px; background: white; border-radius: 8px; 
            border: 2px solid #333; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; color: #2c3e50; font-weight: bold; position: relative;
        }
        .card-number { font-size: 42px; }
        .card.selected { transform: translateY(-15px); border: 3px solid var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        .card.clickable { border: 3px solid var(--accent); animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* ê³µí†µ UI */
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        input { padding: 12px; width: 85%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; background: #ecf0f1; color: #2c3e50; }
        .hidden { display: none !important; }
        .p-badge { display: inline-block; padding: 8px 12px; margin: 4px; border-radius: 20px; font-size: 0.9rem; background: rgba(255,255,255,0.1); border: 1px solid #777; }
        .active-p { border: 2px solid var(--accent); color: var(--accent); background: rgba(241, 196, 15, 0.2); font-weight: bold; }
    </style>
</head>
<body>
    <div id="status-bar">ğŸ“¡ ì‹ í˜¸ê¸° ì¤€ë¹„ ì¤‘...</div>
    <div id="role-header" class="hidden">ğŸ‘‘ ë‹¬ë¬´í‹°: <span id="h-dalmuti">-</span> | ğŸ’© ë†ë…¸: <span id="h-peon">-</span></div>

    <div id="screen-setup" class="screen">
        <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹°</h2>
        <input type="text" id="user-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <div id="setup-btns">
            <button id="btn-make-host" onclick="initHost()">ğŸ° ë°© ë§Œë“¤ê¸° (ë‚´ê°€ ë°©ì¥)</button>
            <button id="btn-make-guest" class="hidden" onclick="initGuest()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-lobby" class="screen hidden">
        <p style="font-size:12px;">ğŸ”— ì•„ë˜ ë§í¬ë¥¼ <b>íŒ€ì›ë“¤ì—ê²Œ</b> ê³µìœ í•˜ì„¸ìš”!</p>
        <button onclick="copyInvite()" style="background:#2980b9; font-size:13px; margin-bottom:15px;">ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬í•˜ê¸°</button>
        <div id="player-list" style="margin-bottom:20px; font-weight:bold;"></div>
        <button id="host-start-btn" class="hidden" onclick="hostGoDraw()" style="background:#27ae60;">ì „ì› ì…ì¥! ì„œì—´ ì •í•˜ê¸° ì‹œì‘</button>
        <p id="guest-wait-msg" class="hidden" style="color:#aaa;">ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>

    <div id="screen-draw" class="screen hidden">
        <h3>ğŸƒ ì„œì—´ ì •í•˜ê¸°</h3>
        <div id="draw-turn-msg" style="color:var(--accent); font-weight:bold; margin-bottom:10px;">ì°¨ë¡€ í™•ì¸ ì¤‘...</div>
        <div id="draw-cards" class="card-container"></div>
        <div id="draw-results" style="margin-top:20px;"></div>
        <button id="btn-to-tax" class="hidden" onclick="hostStartTaxPhase()" style="background:#2ecc71;">ğŸ’° ì„¸ê¸ˆ ë‚©ë¶€ ë‹¨ê³„ë¡œ</button>
    </div>

    <div id="screen-tax" class="screen hidden">
        <h3>ğŸ’° ì„¸ê¸ˆ ë‚©ë¶€ ë° í•˜ì‚¬</h3>
        <div id="tax-msg" style="color:var(--accent); font-weight:bold; margin-bottom:15px; border:1px dashed #777; padding:10px;"></div>
        <div id="tax-cards" class="card-container"></div>
        <button id="tax-confirm-btn" onclick="submitTaxClick()">ì¹´ë“œ í™•ì •</button>
    </div>

    <div id="screen-game" class="screen hidden">
        <div id="game-player-list" style="margin-bottom:15px;"></div>
        <div id="turn-msg" style="padding:10px; border-radius:10px; background:rgba(52, 152, 219, 0.2); border:1px solid #3498db; font-weight:bold;">ì°¨ë¡€ í™•ì¸ ì¤‘...</div>
        <div style="min-height:120px; background:rgba(255,255,255,0.05); border-radius:10px; padding:10px; margin-top:15px;"><div id="table" class="card-container"></div></div>
        <button id="reveal-btn" onclick="revealHand()">ë‚´ ì¹´ë“œ í™•ì¸í•˜ê¸°</button>
        <div id="my-hand" class="card-container hidden"></div>
        <div id="actions" class="hidden" style="margin-top:20px;">
            <button onclick="playCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

<script>
    let peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });
    let conns = {}, myRole, myHand = [], selected = [], myId, hostPeerId;
    let state = { players: [], status: 'setup', turnIdx: 0, last: {rank:14, count:0}, rankDeck: [], taxStorage: [] };
    const roomParam = new URLSearchParams(window.location.search).get('room');

    peer.on('open', id => { 
        myId = id; document.getElementById('status-bar').innerText = "ğŸŸ¢ ì‹ í˜¸ ì¤€ë¹„ ì™„ë£Œ"; document.getElementById('status-bar').classList.add('online');
        if(roomParam) { hostPeerId = roomParam; document.getElementById('btn-make-host').classList.add('hidden'); document.getElementById('btn-make-guest').classList.remove('hidden'); }
    });

    function initHost() { 
        myRole = 'host'; hostPeerId = myId; const n = document.getElementById('user-name').value || "ë°©ì¥";
        state.players = [{id: myId, name: n, rankVal: 0, role: 'ì‹¬ì‚¬ì¤‘', cards: 0, finished: false}];
        state.status = 'lobby'; 
        refresh(); 
        peer.on('connection', c => { c.on('open', () => { c.on('data', d => handle(d, c)); }); });
    }

    function initGuest() { 
        const n = document.getElementById('user-name').value || "ì°¸ê°€ì"; const c = peer.connect(hostPeerId);
        c.on('open', () => { 
            myRole = 'guest'; conns[hostPeerId] = c; c.send({type: 'JOIN', name: n}); 
            c.on('data', d => handle(d, c));
        });
    }

    function handle(d, c) {
        if(d.type === 'JOIN') { 
            conns[c.peer] = c; if(!state.players.find(p => p.id === c.peer)) state.players.push({id: c.peer, name: d.name, rankVal: 0, role: 'ì‹¬ì‚¬ì¤‘', cards: 0, finished: false});
            if(state.players.length >= 2) document.getElementById('host-start-btn').classList.remove('hidden');
            sync(); refresh();
        }
        if(d.type === 'SYNC') { state = d.state; if(d.hand) myHand = d.hand; refresh(); }
        if(d.type === 'PICK_REQ') { const p = state.players.find(x => x.id === c.peer); p.rankVal = state.rankDeck.pop(); state.turnIdx++; checkPicked(); }
        if(d.type === 'TAX_SUBMIT') { state.taxStorage.push({from: d.id, cards: d.cards}); checkTaxDone(); }
    }

    function hostGoDraw() { state.status = 'draw'; state.turnIdx = 0; state.rankDeck = Array.from({length: 12}, (_, i) => i + 1).sort(() => Math.random() - 0.5); sync(); refresh(); }

    function refresh() {
        const screens = ['setup', 'lobby', 'draw', 'tax', 'game'];
        screens.forEach(s => document.getElementById('screen-' + s).classList.add('hidden'));
        document.getElementById('screen-' + state.status).classList.remove('hidden');

        if(state.status === 'lobby') document.getElementById('player-list').innerHTML = "ì°¸ê°€ì: " + state.players.map(p => `<span class="p-badge">${p.name}</span>`).join('');
        if(state.status === 'draw') renderDraw();
        if(state.status === 'tax') renderTax();
        if(state.status === 'game') renderGame();
        
        if(state.players.length > 0 && state.status !== 'lobby' && state.players[0].rankVal > 0) {
            const dal = state.players[0], peon = state.players[state.players.length-1];
            document.getElementById('h-dalmuti').innerText = dal.name; document.getElementById('h-peon').innerText = peon.name;
            document.getElementById('role-header').classList.remove('hidden');
        }
    }

    function renderDraw() {
        const div = document.getElementById('draw-cards'), curr = state.players[state.turnIdx];
        document.getElementById('draw-turn-msg').innerText = curr ? (curr.id === myId ? "â­ ë‹¹ì‹ ì´ ë½‘ì„ ì°¨ë¡€!" : `ğŸ“¢ [${curr.name}] ë‹˜ ì°¨ë¡€`) : "ì™„ë£Œ";
        div.innerHTML = ""; state.players.forEach(p => {
            const c = document.createElement('div'); c.className = 'card';
            if(p.rankVal > 0) c.innerHTML = `<div class="card-number">${p.rankVal}</div>`;
            else { c.innerHTML = `<div class="card-number">?</div>`;
                if(p.id === myId && curr && curr.id === myId) { c.classList.add('clickable');
                    c.onclick = () => { if(myRole === 'host') { state.players[0].rankVal = state.rankDeck.pop(); state.turnIdx++; checkPicked(); } else conns[hostPeerId].send({type: 'PICK_REQ'}); };
                }
            } div.appendChild(c);
        });
    }

    function checkPicked() {
        if(state.turnIdx >= state.players.length) {
            state.players.sort((a,b) => a.rankVal - b.rankVal);
            state.players.forEach((p, i) => p.role = i===0 ? "ğŸ‘‘ ë‹¬ë¬´í‹°" : (i===state.players.length-1 ? "ğŸ’© ë†ë…¸" : `${i+1}ë“± í‰ë¯¼`));
            document.getElementById('draw-results').innerHTML = state.players.map(p => `<div>${p.role}: ${p.name}</div>`).join('');
            if(myRole === 'host') document.getElementById('btn-to-tax').classList.remove('hidden');
        } sync(); refresh();
    }

    function hostStartTaxPhase() {
        let dk = []; for(let i=1; i<=12; i++) for(let j=0; j<i; j++) dk.push(i); dk.push(13, 13); dk.sort(()=>Math.random()-0.5);
        state.status = 'tax'; state.taxStorage = []; state.last = {rank:14, count:0};
        state.players.forEach((p, i) => { 
            let h = []; for(let j=i; j<dk.length; j+=state.players.length) h.push(dk[j]);
            p.cards = h.length; p.finished = false; if(p.id === myId) myHand = h; else conns[p.id].send({type: 'SYNC', state, hand: h});
        }); sync(); refresh();
    }

    function renderTax() {
        const me = state.players.find(p => p.id === myId), dal = state.players[0], peon = state.players[state.players.length-1];
        document.getElementById('tax-msg').innerText = (me.id === peon.id) ? "ğŸ’© ë†ë…¸ë‹˜, ì¡°ê³µ ì¹´ë“œ 2ì¥ì„ ì„ íƒí•˜ì„¸ìš”." : (me.id === dal.id) ? "ğŸ‘‘ ë‹¬ë¬´í‹°ë‹˜, í•˜ì‚¬í•  ì¹´ë“œ 2ì¥ì„ ì„ íƒí•˜ì„¸ìš”." : "ëŒ€ê¸° ì¤‘...";
        const div = document.getElementById('tax-cards'); div.innerHTML = "";
        if(me.id === peon.id || me.id === dal.id) {
            myHand.sort((a,b)=>a-b).forEach((r, i) => {
                const c = document.createElement('div'); c.className = 'card'; c.innerHTML = `<div class="card-number">${r===13?'J':r}</div>`;
                c.onclick = () => { c.classList.toggle('selected'); const idx = selected.findIndex(x=>x.i===i); if(idx>-1) selected.splice(idx,1); else selected.push({r, i}); };
                div.appendChild(c);
            });
        } selected = [];
    }

    function submitTaxClick() {
        if(selected.length !== 2) return alert("2ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");
        const me = state.players.find(p => p.id === myId), peon = state.players[state.players.length-1];
        if(me.id === peon.id) {
            const best = [...myHand].sort((a,b)=>a-b).slice(0,2);
            if(!selected.map(s => s.r).sort((a,b)=>a-b).every((v,i)=>v===best[i])) return alert(`ë†ë…¸ì—¬! ì–´ë”” ê°íˆ ê±°ì§“ì„ ê³ í•˜ëŠëƒ. ${best[0]}ë²ˆ, ${best[1]}ë²ˆ ì¹´ë“œë¥¼ ë‚´ê±°ë¼.`);
        }
        const cards = selected.map(s => s.r); selected.sort((a,b)=>b.i-a.i).forEach(s => myHand.splice(s.i, 1));
        if(myRole === 'host') { state.taxStorage.push({from: myId, cards}); checkTaxDone(); } else conns[hostPeerId].send({type: 'TAX_SUBMIT', id: myId, cards});
        document.getElementById('screen-tax').innerHTML = "<h3>ì¡°ê³µ ì™„ë£Œ! ëŒ€ê¸° ì¤‘...</h3>";
    }

    function checkTaxDone() {
        if(state.taxStorage.length === 2) {
            const dal = state.players[0], peon = state.players[state.players.length-1];
            const pToD = state.taxStorage.find(x => x.from === peon.id).cards, dToP = state.taxStorage.find(x => x.from === dal.id).cards;
            state.status = 'game'; state.turnIdx = 0;
            state.players.forEach(p => {
                let h = (p.id === myId) ? [...myHand] : [];
                if(p.id === dal.id) h = h.concat(pToD); else if(p.id === peon.id) h = h.concat(dToP);
                p.cards = h.length; if(p.id === myId) myHand = h.sort((a,b)=>a-b); else conns[p.id].send({type: 'SYNC', state, hand: h.sort((a,b)=>a-b)});
            }); sync(); refresh();
        }
    }

    function renderGame() {
        const turnP = state.players[state.turnIdx];
        document.getElementById('turn-msg').innerText = turnP.id === myId ? "â­ ë‹¹ì‹  ì°¨ë¡€!" : `ğŸ“¢ [${turnP.name}] ì°¨ë¡€`;
        document.getElementById('game-player-list').innerHTML = state.players.map(p => `<span class="p-badge ${p.id===turnP.id?'active-p':''}"> ${p.role.split(' ')[1]} ${p.name}: <b>ğŸ´${p.finished ? 'íƒˆì¶œ' : p.cards}</b> </span>`).join('');
        const t = document.getElementById('table'); t.innerHTML = "";
        for(let i=0; i<state.last.count; i++) t.innerHTML += `<div class="card"><div class="card-number">${state.last.rank===13?'J':state.last.rank}</div></div>`;
        document.getElementById('my-hand').classList.add('hidden'); document.getElementById('actions').classList.add('hidden');
    }

    function revealHand() {
        const div = document.getElementById('my-hand'); div.innerHTML = ""; div.classList.remove('hidden'); document.getElementById('actions').classList.remove('hidden');
        myHand.forEach((r, i) => {
            const c = document.createElement('div'); c.className = 'card'; c.innerHTML = `<div class="card-number">${r===13?'J':r}</div>`;
            c.onclick = () => { c.classList.toggle('selected'); const idx = selected.findIndex(x=>x.i===i); if(idx>-1) selected.splice(idx,1); else selected.push({r, i}); };
            div.appendChild(c);
        }); selected = [];
    }

    function playCards() {
        if(state.players[state.turnIdx].id !== myId) return alert("ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤.");
        if(selected.length === 0) return;
        const r = selected[0].r;
        if(state.last.count === 0 || (selected.length === state.last.count && r < state.last.rank)) {
            state.last = {rank: r, count: selected.length}; selected.sort((a,b)=>b.i-a.i).forEach(s => myHand.splice(s.i, 1));
            state.players.find(p => p.id === myId).cards = myHand.length;
            if(myHand.length === 0) state.players.find(p => p.id === myId).finished = true;
            do { state.turnIdx = (state.turnIdx + 1) % state.players.length; } while(state.players[state.turnIdx].finished);
            sync(); refresh();
        } else alert("ë¶ˆê°€ëŠ¥!");
    }

    function passTurn() { if(state.players[state.turnIdx].id !== myId) return; do { state.turnIdx = (state.turnIdx + 1) % state.players.length; } while(state.players[state.turnIdx].finished); sync(); refresh(); }
    function sync() { if(myRole === 'host') Object.values(conns).forEach(c => c.send({type: 'SYNC', state})); }
    function copyInvite() { navigator.clipboard.writeText(window.location.origin + window.location.pathname + "?room=" + myId).then(() => alert("ë³µì‚¬ ì™„ë£Œ!")); }
</script>
</body>
</html>
