<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¬ë¬´í‹° ë©€í‹°í”Œë ˆì´ ì™„ì„±ë³¸</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #1a252f; --accent: #f1c40f; --dalmuti-color: #f1c40f; --peon-color: #95a5a6; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); color: white; margin: 0; padding: 10px; text-align: center; }
        
        #status-bar { padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; background: #c0392b; font-weight: bold; }
        .online { background: #27ae60 !important; }

        .screen { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #34495e; }
        
        #rank-board { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--accent); }
        .rank-badge { display: inline-block; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }

        .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; min-height: 110px; }
        .card { 
            width: 65px; height: 95px; background: white; border-radius: 8px; 
            border: 2px solid #333; cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center; color: #2c3e50;
        }
        .card-number { font-size: 32px; font-weight: bold; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: absolute; border-radius: 6px; }
        .card.selected { transform: translateY(-15px); border: 3px solid var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 10; }
        
        button { padding: 12px 20px; border-radius: 8px; border: none; background: #e67e22; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; }
        button:disabled { background: #7f8c8d; }
        .table-area { min-height: 120px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 15px 0; padding: 10px; border: 1px dashed #555; }
        .hidden { display: none !important; }
        
        input { padding: 12px; width: 80%; border-radius: 5px; border: 2px solid #34495e; font-size: 16px; margin-bottom: 10px; text-align: center; }
        .role-item { margin: 10px 0; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="status-bar">ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

    <div id="setup" class="screen">
        <h2 style="color:var(--accent)">ğŸ° ë‹¬ë¬´í‹° ì˜¨ë¼ì¸</h2>
        <input type="text" id="my-name" placeholder="ë‚´ ì´ë¦„ ì…ë ¥">
        <button onclick="initPeer(true)">ìƒˆ ê²Œì„ ë°© ë§Œë“¤ê¸°</button>
        <hr style="border:0.5px solid #444; margin:15px 0;">
        <input type="text" id="join-id" placeholder="ë°© ì½”ë“œ ìë™ ì…ë ¥ë¨">
        <button onclick="initPeer(false)" style="background:#2980b9;">ë°© ì°¸ì—¬í•˜ê¸°</button>
    </div>

    <div id="lobby" class="screen hidden">
        <h3>ğŸ“¢ ëŒ€ê¸°ì‹¤</h3>
        <button onclick="copyRoomLink()" style="background:#8e44ad; width:auto; margin-bottom:15px;">ğŸ”— ì´ˆëŒ€ ë§í¬ ë³µì‚¬</button>
        <div id="player-list-lobby"></div>
        <button id="start-btn" onclick="startRoleDrawing()" class="hidden">ì„œì—´ ì •í•˜ê¸° ì‹œì‘</button>
    </div>

    <div id="role-draw" class="screen hidden">
        <h3>ğŸƒ ì²« ì„œì—´ ì •í•˜ê¸°</h3>
        <div id="role-cards" class="card-container"></div>
        <div id="role-results" style="margin-top:20px;"></div>
    </div>

    <div id="tax-phase" class="screen hidden">
        <h3>ğŸ’° ì„¸ê¸ˆ ë° í•˜ì‚¬ ë‹¨ê³„</h3>
        <p id="tax-instruction"></p>
        <div id="tax-hand" class="card-container"></div>
        <p id="tax-msg" style="color:#e74c3c; font-weight:bold;"></p>
        <button id="tax-btn" onclick="submitTax()">ì¹´ë“œ ì „ë‹¬í•˜ê¸°</button>
    </div>

    <div id="game-board" class="screen hidden">
        <div id="rank-board"></div>
        <div id="turn-display" style="font-size:1.2rem; color:var(--accent); margin-bottom:10px;"></div>
        <div class="table-area"><div id="table-cards" class="card-container"></div></div>
        <div id="my-hand" class="card-container"></div>
        <div style="margin-top:20px;">
            <button onclick="playCards()">ì¹´ë“œ ë‚´ê¸°</button>
            <button onclick="passTurn()" style="background:#7f8c8d;">í†µê³¼ (Pass)</button>
        </div>
    </div>

    <div id="result-screen" class="screen hidden">
        <h3>ğŸ† ë¼ìš´ë“œ ì¢…ë£Œ</h3>
        <div id="final-ranks"></div>
        <button onclick="restart(true)" style="background:#2ecc71; margin-top:20px;">ì´ ì‹ ë¶„ ê·¸ëŒ€ë¡œ í•œ íŒ ë”!</button>
        <button onclick="restart(false)" style="background:#e74c3c;">ì„œì—´ ì´ˆê¸°í™” ë° ìƒˆë¡œ ì‹œì‘</button>
    </div>

<script>
    const IMG_BASE = "https://raw.githubusercontent.com/hmkim199/java-dalmuti/master/src/dalmuti/img/";
    let peer, conn, connections = [];
    let isHost = false, myID = "", myName = "";
    let players = [], currentPlayerIdx = 0, lastPlayed = {rank:14, count:0}, selectedCards = [], passCount = 0;
    let finishOrder = [], taxStorage = [];

    // [ì´ˆê¸° ì„¤ì •]
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('room')) document.getElementById('join-id').value = urlParams.get('room');
    };

    function copyRoomLink() {
        const link = `${window.location.origin}${window.location.pathname}?room=${myID}`;
        navigator.clipboard.writeText(link).then(() => alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }

    function initPeer(host) {
        myName = document.getElementById('my-name').value;
        if (!myName) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
        isHost = host;
        peer = new Peer();
        peer.on('open', id => {
            myID = id;
            updateStatus("ì—°ê²° ì„±ê³µ", true);
            if(isHost) {
                players.push({id, name:myName, role:"ë‹¬ë¬´í‹°", hand:[], isFinished:false});
                showScreen('lobby');
                updateLobby();
            } else {
                conn = peer.connect(document.getElementById('join-id').value);
                setupConn(conn);
            }
        });
        peer.on('connection', setupConn);
    }

    function setupConn(c) {
        if(isHost) connections.push(c);
        c.on('open', () => isHost ? null : c.send({type:'JOIN', name:myName}));
        c.on('data', data => handleData(data, c));
    }

    function handleData(data, c) {
        if(data.type === 'JOIN' && isHost) {
            players.push({id:c.peer, name:data.name, role:"ë†ë…¸", hand:[], isFinished:false});
            updateLobby();
            broadcast({type:'LOBBY', players});
        }
        if(data.type === 'LOBBY') { players = data.players; updateLobby(); showScreen('lobby'); }
        if(data.type === 'START_DRAW') showRoleDraw(data.count);
        if(data.type === 'ROLE_OPEN') updateRoleCard(data.idx, data.rank, data.pName);
        if(data.type === 'TAX_START') { players = data.players; startTaxPhase(); }
        if(data.type === 'TAX_MSG') document.getElementById('tax-msg').innerText = data.msg;
        if(data.type === 'DALMUTI_TURN') {
            taxStorage = data.cards;
            if(players[0].id === myID) {
                document.getElementById('tax-instruction').innerHTML = "ë†ë…¸ê°€ ë°”ì¹œ ì¹´ë“œë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. <br>ì´ì œ <b>ì•„ë¬´ ì¹´ë“œë‚˜ 2ì¥</b>ì„ í•˜ì‚¬í•˜ì‹­ì‹œì˜¤.";
                document.getElementById('tax-btn').classList.remove('hidden');
            }
        }
        if(data.type === 'GAME_START') {
            players = data.players; currentPlayerIdx = data.turn; lastPlayed = data.last;
            showScreen('game-board'); updateUI();
        }
    }

    function broadcast(data) { connections.forEach(c => c.send(data)); }

    // [ë¡œì§: ì„œì—´ ì •í•˜ê¸°]
    function startRoleDrawing() {
        broadcast({type:'START_DRAW', count:players.length});
        showRoleDraw(players.length);
    }

    function showRoleDraw(count) {
        showScreen('role-draw');
        const container = document.getElementById('role-cards');
        container.innerHTML = '';
        for(let i=0; i<count; i++) container.innerHTML += `<div class="card" onclick="drawRank(${i})">?</div>`;
    }

    function drawRank(idx) {
        if(!isHost) return;
        let rank = Math.floor(Math.random()*12)+1;
        const pIdx = players.findIndex(p => !p.initRank);
        players[pIdx].initRank = rank;
        const msg = {type:'ROLE_OPEN', idx, rank, pName:players[pIdx].name};
        handleData(msg); broadcast(msg);
        if(players.every(p => p.initRank)) setTimeout(finalizeRoles, 1500);
    }

    function updateRoleCard(idx, rank, name) {
        const card = document.getElementById('role-cards').children[idx];
        card.innerHTML = `<div class="card-number">${rank}</div><img src="${IMG_BASE}${rank}.png">`;
        document.getElementById('role-results').innerHTML += `<div>${name}: ${rank}</div>`;
    }

    function finalizeRoles() {
        players.sort((a,b) => a.initRank - b.initRank);
        players.forEach((p,i) => p.role = i==0?"ğŸ‘‘ ë‹¬ë¬´í‹°": (i==players.length-1?"ğŸ’© ë†ë…¸": "í‰ë¯¼"));
        dealCards();
    }

    function dealCards() {
        let deck = []; for(let i=1; i<=12; i++) for(let j=0; j<i; j++) deck.push(i);
        deck.push(13,13); deck.sort(()=>Math.random()-0.5);
        players.forEach(p => p.hand = []);
        let i=0; while(deck.length) players[i++ % players.length].hand.push(deck.pop());
        players.forEach(p => p.hand.sort((a,b)=>a-b));
        const msg = {type:'TAX_START', players};
        handleData(msg); broadcast(msg);
    }

    // [ë¡œì§: ì„¸ê¸ˆ ë‹¨ê³„]
    function startTaxPhase() {
        showScreen('tax-phase');
        const me = players.find(p => p.id === myID);
        const isPeon = players[players.length-1].id === myID;
        const isDal = players[0].id === myID;
        
        document.getElementById('tax-btn').classList.toggle('hidden', !isPeon);
        document.getElementById('tax-instruction').innerHTML = isPeon ? "ë‹¬ë¬´í‹°ì—ê²Œ ë°”ì¹  <b>ê°€ì¥ ì¢‹ì€ ì¹´ë“œ 2ì¥</b>ì„ ê³ ë¥´ì„¸ìš”." : (isDal ? "ë†ë…¸ì˜ ì¡°ê³µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..." : "ì„¸ê¸ˆ ë‚©ë¶€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...");
        renderTaxHand(me.hand);
    }

    function renderTaxHand(hand) {
        const container = document.getElementById('tax-hand');
        container.innerHTML = ''; selectedCards = [];
        hand.forEach((rank, idx) => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<div class="card-number">${rank}</div><img src="${IMG_BASE}${rank}.png">`;
            c.onclick = () => { c.classList.toggle('selected'); toggleSelect(rank, idx); };
            container.appendChild(c);
        });
    }

    function toggleSelect(rank, idx) {
        const i = selectedCards.findIndex(s => s.idx === idx);
        if(i > -1) selectedCards.splice(i, 1); else selectedCards.push({rank, idx});
    }

    function submitTax() {
        if(selectedCards.length !== 2) return alert("2ì¥ì„ ê³¨ë¼ì•¼ í•©ë‹ˆë‹¤.");
        const pIdx = players.findIndex(p => p.id === myID);
        if(pIdx === players.length-1) { // ë†ë…¸
            const best = [...players[pIdx].hand].sort((a,b)=>a-b).slice(0,2);
            const mine = selectedCards.map(s=>s.rank).sort((a,b)=>a-b);
            if(mine[0]!==best[0] || mine[1]!==best[1]) {
                const err = `ë†ë…¸ ë„¤ ì´ë†ˆ. ê°íˆ ê±°ì§“ì„ ê³ í•˜ë‹¤ë‹ˆ! ${best[0]}ë²ˆ, ${best[1]}ë²ˆ ì¹´ë“œë¥¼ ë‚´ë†“ì•„ë¼!`;
                document.getElementById('tax-msg').innerText = err;
                return;
            }
            // ì¹´ë“œ êµì²´ (ë°©ì¥ì—ê²Œ ì „ì†¡)
            if(isHost) processPeonTax(selectedCards);
            else conn.send({type:'PEON_TAX', cards:selectedCards, pIdx});
        } else { // ë‹¬ë¬´í‹°
            if(isHost) processDalTax(selectedCards);
            else conn.send({type:'DAL_TAX', cards:selectedCards});
        }
    }

    // [ë°©ì¥ ì „ìš© ì²˜ë¦¬]
    function processPeonTax(cards) {
        const peon = players[players.length-1];
        taxStorage = []; 
        cards.sort((a,b)=>b.idx-a.idx).forEach(c => taxStorage.push(peon.hand.splice(c.idx,1)[0]));
        const msg = {type:'DALMUTI_TURN', cards:taxStorage};
        handleData(msg); broadcast(msg);
    }

    function processDalTax(cards) {
        const dal = players[0];
        const peon = players[players.length-1];
        // ë‹¬ë¬´í‹° ì¹´ë“œ ì œê±° í›„ ë†ë…¸ì—ê²Œ, ë†ë…¸ ì¹´ë“œ ë‹¬ë¬´í‹°ì—ê²Œ
        cards.sort((a,b)=>b.idx-a.idx).forEach(c => peon.hand.push(dal.hand.splice(c.idx,1)[0]));
        peon.hand.push(...taxStorage);
        players.forEach(p => p.hand.sort((a,b)=>a-b));
        const msg = {type:'GAME_START', players, turn:0, last:{rank:14, count:0}};
        handleData(msg); broadcast(msg);
    }

    // [ê²Œì„ í”Œë ˆì´ UI]
    function updateUI() {
        const me = players.find(p => p.id === myID);
        const isMyTurn = players[currentPlayerIdx].id === myID;
        document.getElementById('turn-display').innerText = isMyTurn ? "ğŸ”´ ë‚´ ì°¨ë¡€!" : `âŒ› ${players[currentPlayerIdx].name} ì°¨ë¡€`;
        
        document.getElementById('rank-board').innerHTML = players.map(p => `<span class="rank-badge">${p.name}(${p.hand.length})</span>`).join('');
        
        const handDiv = document.getElementById('my-hand'); handDiv.innerHTML = '';
        selectedCards = [];
        me.hand.forEach((rank, idx) => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<div class="card-number">${rank}</div><img src="${IMG_BASE}${rank}.png">`;
            c.onclick = () => { if(isMyTurn) { c.classList.toggle('selected'); toggleSelect(rank, idx); }};
            handDiv.appendChild(c);
        });

        const table = document.getElementById('table-cards'); table.innerHTML = '';
        for(let i=0; i<lastPlayed.count; i++) table.innerHTML += `<div class="card"><div class="card-number">${lastPlayed.rank}</div><img src="${IMG_BASE}${lastPlayed.rank}.png"></div>`;
    }

    function playCards() {
        if(!selectedCards.length) return;
        const rank = selectedCards[0].rank;
        if(!selectedCards.every(c => c.rank === rank)) return alert("ê°™ì€ ìˆ«ìë§Œ ê°€ëŠ¥!");
        if(lastPlayed.count > 0 && (selectedCards.length !== lastPlayed.count || rank >= lastPlayed.rank)) return alert("ë‚¼ ìˆ˜ ì—†ìŒ!");
        
        const pIdx = players.findIndex(p => p.id === myID);
        // ë°©ì¥ì—ê²Œ ì•Œë¦¼
        if(isHost) doPlay(rank, selectedCards.length, pIdx);
        else conn.send({type:'PLAY', rank, count:selectedCards.length, pIdx});
    }

    function doPlay(rank, count, pIdx) {
        lastPlayed = {rank, count};
        for(let i=0; i<count; i++) players[pIdx].hand.splice(players[pIdx].hand.indexOf(rank), 1);
        if(!players[pIdx].hand.length) { players[pIdx].isFinished = true; finishOrder.push(players[pIdx]); }
        passCount = 0; nextTurn();
    }

    function passTurn() {
        if(isHost) doPass(); else conn.send({type:'PASS'});
    }

    function doPass() {
        passCount++;
        if(passCount >= players.filter(p=>!p.isFinished).length - 1) lastPlayed = {rank:14, count:0};
        nextTurn();
    }

    function nextTurn() {
        const active = players.filter(p => !p.isFinished);
        if(active.length <= 1) {
            if(active.length === 1) finishOrder.push(active[0]);
            const msg = {type:'RESULT', players:finishOrder};
            handleData(msg); broadcast(msg); return;
        }
        do { currentPlayerIdx = (currentPlayerIdx + 1) % players.length; } while(players[currentPlayerIdx].isFinished);
        const msg = {type:'GAME_START', players, turn:currentPlayerIdx, last:lastPlayed};
        handleData(msg); broadcast(msg);
    }

    function restart(keepRank) {
        if(!isHost) return alert("ë°©ì¥ë§Œ ê°€ëŠ¥!");
        if(!keepRank) return location.reload();
        players = [...finishOrder].map(p => ({...p, hand:[], isFinished:false, initRank:null}));
        finishOrder = []; dealCards();
    }

    // ìœ í‹¸ë¦¬í‹°
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function updateStatus(m, o) { const s = document.getElementById('status-bar'); s.innerText = m; if(o) s.classList.add('online'); }
    function updateLobby() { 
        document.getElementById('player-list-lobby').innerHTML = players.map(p => `<div>ğŸ‘¤ ${p.name}</div>`).join('');
        if(isHost && players.length >= 2) document.getElementById('start-btn').classList.remove('hidden');
    }
</script>
</body>
</html>
